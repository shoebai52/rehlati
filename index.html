<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="theme-color" content="#1a237e">
    <meta name="description" content="Rihlati Fleet Management System - Professional fleet tracking and reporting">
    <title>Rihlati Fleet Management System</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary-color: #1a237e;
            --secondary-color: #3949ab;
            --accent-color: #ff5722;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --text-color: #333;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 6px 16px rgba(0,0,0,0.1);
            --sidebar-width: 280px;
            --header-height: 70px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Loading Spinner */
        #globalLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Login Page */
        .login-container {
            max-width: 420px;
            margin: 80px auto;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            animation: slideInUp 0.6s ease;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 48px;
            box-shadow: 0 10px 30px rgba(26, 35, 126, 0.3);
        }

        .login-header h1 {
            color: var(--primary-color);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 14px;
        }

        .login-form .form-group {
            margin-bottom: 25px;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 14px;
        }

        .login-form input {
            width: 100%;
            padding: 15px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--secondary-color);
            background: white;
            box-shadow: 0 0 0 4px rgba(57, 73, 171, 0.1);
        }

        .login-form button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            box-shadow: 0 10px 20px rgba(26, 35, 126, 0.2);
        }

        .login-form button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(26, 35, 126, 0.3);
        }

        .login-form button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Main App Layout */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.show {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1a237e 0%, #0d1b3e 100%);
            color: white;
            padding: 25px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 5px 0 20px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 0 25px 25px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .user-profile {
            padding: 20px 25px;
            background: rgba(255,255,255,0.05);
            margin: 20px 15px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-color), #ff7043);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        .user-details h4 {
            font-size: 15px;
            margin-bottom: 3px;
        }

        .user-details p {
            font-size: 12px;
            opacity: 0.7;
        }

        .nav-menu {
            margin-top: 30px;
        }

        .nav-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            min-height: 44px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: var(--accent-color);
        }

        .nav-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: var(--accent-color);
        }

        .nav-item i {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            min-height: 100vh;
            background: var(--bg-color);
        }

        .top-bar {
            background: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            height: var(--header-height);
        }

        .top-bar h1 {
            font-size: 28px;
            color: var(--primary-color);
        }

        .top-bar-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
            min-width: 44px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.2);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(26, 35, 126, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: var(--text-color);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Content Sections */
        .content-section {
            padding: 40px;
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        /* Report Form */
        .form-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            max-width: 800px;
            margin: 0 auto;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group label .required {
            color: var(--danger-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(57, 73, 171, 0.1);
        }

        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: var(--danger-color);
        }

        .error-message {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .table-header {
            padding: 20px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            width: 300px;
            background: rgba(255,255,255,0.2);
            color: white;
            min-height: 44px;
        }

        .search-box::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Mobile Table */
        @media (max-width: 768px) {
            .table-responsive table,
            .table-responsive thead,
            .table-responsive tbody,
            .table-responsive th,
            .table-responsive td,
            .table-responsive tr {
                display: block;
            }

            .table-responsive thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            .table-responsive td {
                border: none;
                position: relative;
                padding-left: 50%;
                min-height: 44px;
            }

            .table-responsive td:before {
                position: absolute;
                left: 12px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: bold;
                content: attr(data-label);
            }
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge-approved {
            background: #d4edda;
            color: #155724;
        }

        .badge-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-icon {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            min-height: 36px;
            min-width: 36px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideInUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h3 {
            color: var(--primary-color);
            font-size: 22px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            min-height: 44px;
            min-width: 44px;
        }

        .close-btn:hover {
            color: var(--danger-color);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--success-color);
            color: white;
            padding: 18px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 3000;
            animation: slideInRight 0.3s ease;
        }

        .toast.show {
            display: flex;
        }

        .toast.error {
            background: var(--danger-color);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
            }
            to {
                transform: translateX(0);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #666;
        }

        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .chart-title {
            color: var(--primary-color);
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .chart-grid {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            height: 200px;
            padding: 20px 0;
        }

        .chart-bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .chart-bar {
            width: 60px;
            background: linear-gradient(180deg, var(--secondary-color), var(--primary-color));
            border-radius: 8px 8px 0 0;
            transition: height 0.3s ease;
        }

        .chart-label {
            font-size: 12px;
            color: #666;
        }

        .chart-value {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--info-color));
            transition: width 0.3s ease;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 1001;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .top-bar {
                padding: 15px 20px;
            }

            .top-bar h1 {
                font-size: 20px;
            }

            .content-section {
                padding: 20px;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
                width: 95%;
            }

            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                width: 100%;
            }
        }

        /* Hamburger Menu */
        .hamburger-menu {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--primary-color);
            min-height: 44px;
            min-width: 44px;
        }

        @media (max-width: 768px) {
            .hamburger-menu {
                display: block;
            }
        }

        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .menu-overlay.show {
            display: block;
        }

        .sidebar-close-btn {
            display: none;
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            border-radius: 8px;
            padding: 6px 10px;
            margin-top: 12px;
            transition: background 0.2s;
        }

        .sidebar-close-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        @media (max-width: 768px) {
            .sidebar-close-btn {
                display: inline-block;
            }
        }

        /* ===== TICKET SYSTEM ===== */
        .ticket-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .ticket-type-card {
            border: 2px solid #e0e0e0;
            border-radius: 14px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s;
            background: #fafafa;
        }
        .ticket-type-card:hover { border-color: var(--secondary-color); background: #f0f4ff; }
        .ticket-type-card.selected {
            border-color: var(--secondary-color);
            background: linear-gradient(135deg, #e8eaf6, #f3e5f5);
            box-shadow: 0 4px 14px rgba(57,73,171,0.18);
        }
        .ticket-type-card .ticket-icon { font-size: 36px; margin-bottom: 8px; }
        .ticket-type-card .ticket-label { font-size: 13px; font-weight: 600; color: var(--primary-color); }

        .ticket-form-step { display: none; }
        .ticket-form-step.active { display: block; }

        .badge-maintenance { background: #fff3e0; color: #e65100; }
        .badge-fuel        { background: #e3f2fd; color: #1565c0; }
        .badge-leave       { background: #fce4ec; color: #ad1457; }
        .badge-new         { background: #e8f5e9; color: #2e7d32; }

        .ticket-row-maintenance td:first-child { border-left: 4px solid #ff9800; }
        .ticket-row-fuel        td:first-child { border-left: 4px solid #2196f3; }
        .ticket-row-leave       td:first-child { border-left: 4px solid #e91e63; }

        .priority-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .priority-low    { background: #e8f5e9; color: #388e3c; }
        .priority-medium { background: #fff8e1; color: #f57f17; }
        .priority-high   { background: #fff3e0; color: #e65100; }
        .priority-urgent { background: #ffebee; color: #c62828; }

        .step-indicator {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 22px;
        }
        .step-dot {
            width: 28px; height: 28px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700;
            background: #e0e0e0; color: #888;
            transition: all 0.3s;
        }
        .step-dot.active  { background: var(--secondary-color); color: white; }
        .step-dot.done    { background: var(--success-color);   color: white; }
        .step-line { flex: 1; height: 2px; background: #e0e0e0; border-radius: 2px; }
        .step-line.done { background: var(--success-color); }

        .ticket-detail-row { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .ticket-detail-row:last-child { border-bottom: none; }
        .ticket-detail-label { font-weight: 600; color: #555; min-width: 140px; font-size: 13px; }
        .ticket-detail-value { color: #333; font-size: 13px; flex: 1; }

        @media (max-width: 768px) {
            .ticket-type-grid { grid-template-columns: 1fr; }
        }

        /* ===== GOOGLE SHEETS SYNC ===== */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 7px;
            font-size: 13px;
            padding: 7px 13px;
            border-radius: 8px;
            font-weight: 600;
            cursor: default;
            border: 1.5px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .sync-status.connected    { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
        .sync-status.syncing      { background: #e3f2fd; color: #1565c0; border-color: #90caf9; }
        .sync-status.offline      { background: #fff3e0; color: #e65100; border-color: #ffcc80; }
        .sync-status.not-linked   { background: #f5f5f5; color: #757575; border-color: #e0e0e0; cursor: pointer; }
        .sync-status.not-linked:hover { background: #eeeeee; }
        .sync-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .connected  .sync-dot { background: #4caf50; box-shadow: 0 0 0 3px rgba(76,175,80,0.25); }
        .syncing    .sync-dot { background: #2196f3; animation: pulse-dot 1s infinite; }
        .offline    .sync-dot { background: #ff9800; }
        .not-linked .sync-dot { background: #9e9e9e; }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: 0.5; transform: scale(0.7); }
        }

        /* Settings Modal */
        .settings-section { margin-bottom: 24px; }
        .settings-section h4 {
            color: var(--primary-color);
            font-size: 15px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }
        .sheet-url-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }
        .sheet-url-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(57,73,171,0.1);
        }
        .sheet-url-input.valid   { border-color: var(--success-color); }
        .sheet-url-input.invalid { border-color: var(--danger-color); }

        .sync-info-box {
            background: #f0f4ff;
            border: 1px solid #c5cae9;
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 13px;
            color: #37474f;
            line-height: 1.7;
        }
        .sync-info-box ol { margin: 8px 0 0 18px; }
        .sync-info-box code {
            background: #e8eaf6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }
        .sync-last-time {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }

        /* ===== RTL / ARABIC SUPPORT ===== */
        body[dir="rtl"] .sidebar {
            left: auto;
            right: 0;
            box-shadow: -5px 0 20px rgba(0,0,0,0.1);
        }

        body[dir="rtl"] .main-content {
            margin-left: 0;
            margin-right: var(--sidebar-width);
        }

        body[dir="rtl"] .nav-item {
            border-left: none;
            border-right: 3px solid transparent;
        }

        body[dir="rtl"] .nav-item:hover,
        body[dir="rtl"] .nav-item.active {
            border-right-color: var(--accent-color);
        }

        body[dir="rtl"] .top-bar-actions {
            flex-direction: row-reverse;
        }

        body[dir="rtl"] .sidebar {
            transform: translateX(100%);
        }

        body[dir="rtl"] .sidebar.mobile-open {
            transform: translateX(0);
        }

        @media (min-width: 769px) {
            body[dir="rtl"] .sidebar {
                transform: none;
            }
        }

        .lang-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            min-height: 36px;
        }

        .lang-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        /* Login page RTL */
        body[dir="rtl"] .login-form input,
        body[dir="rtl"] .login-form button {
            text-align: right;
        }

        /* Financial specific styles */
        .financial-row td:first-child { border-left: 4px solid #4caf50; }
        .financial-highlight { background: rgba(76, 175, 80, 0.05); }
        .financial-badge { background: #e8f5e9; color: #2e7d32; }
        .amount-pending { color: #f57f17; font-weight: 600; }
        .amount-approved { color: #2e7d32; font-weight: 600; }
        .amount-rejected { color: #c62828; font-weight: 600; }
        .amount-total { font-size: 18px; font-weight: 700; color: var(--primary-color); }
        
        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
        }
        .summary-card h4 {
            color: #666;
            font-size: 13px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .summary-card .amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }
        .summary-card .sub {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        /* Admin-only approval buttons */
        .admin-only {
            display: none;
        }
        .admin-visible {
            display: inline-flex;
        }
    </style>
</head>
<body>
    <!-- Global Loader -->
    <div id="globalLoader">
        <div class="spinner"></div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div style="text-align: right; margin-bottom: 10px;">
            <button onclick="toggleLanguage()" style="background: none; border: 1px solid #ccc; border-radius: 8px; padding: 6px 14px; cursor: pointer; font-size: 13px; color: #555;">üåê ÿπÿ±ÿ®Ÿä / EN</button>
        </div>
        <div class="login-header">
            <div class="login-logo">üöó</div>
            <h1>Rihlati Fleet</h1>
            <p>Fleet Management System</p>
        </div>
        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="loginUsername" placeholder="Enter username" required 
                       aria-label="Username" autocomplete="username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password" required 
                       aria-label="Password" autocomplete="current-password">
            </div>
            <button type="submit" id="loginBtn">
                <span>Sign In</span>
            </button>
        </form>
        <div class="login-footer">
            <p style="margin-top: 20px; font-size: 12px; color: #999;">
                &copy; 2026 Rihlati Fleet Management System
            </p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container">
        <!-- Mobile Menu Overlay -->
        <div id="menuOverlay" class="menu-overlay" onclick="toggleMobileMenu()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>üöó Rihlati</h2>
                <p>Fleet Management</p>
                <button class="sidebar-close-btn" onclick="toggleMobileMenu()" aria-label="Close menu">‚úï</button>
            </div>

            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <h4 id="userName">Admin</h4>
                    <p id="sidebarUserRole">Administrator</p>
                </div>
            </div>

            <nav class="nav-menu" id="navMenu" aria-label="Main navigation">
                <!-- Navigation items will be loaded dynamically -->
            </nav>

            <div class="nav-item" onclick="logout()" style="position: absolute; bottom: 20px; width: calc(100% - 40px); margin: 0 20px;" role="button" tabindex="0">
                <i>üö™</i>
                <span id="logoutLabel">Logout</span>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <button class="hamburger-menu" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
                <h1 id="currentPageTitle">Dashboard</h1>
                <div class="top-bar-actions" id="topBarActions"></div>
                <div id="adminOnlyControls" style="display:none; align-items:center; gap:8px;">
                    <div id="syncStatus" class="sync-status not-linked" onclick="openModal('settingsModal')" title="Google Sheets settings">
                        <span class="sync-dot"></span>
                        <span id="syncStatusText">Not linked</span>
                    </div>
                    <button class="lang-btn" onclick="openModal('settingsModal')" title="Settings" style="padding: 8px 10px;">‚öôÔ∏è</button>
                </div>
                <button class="lang-btn" id="langToggle" onclick="toggleLanguage()" title="Switch Language">ÿπÿ±ÿ®Ÿä</button>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="content-section active">
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats cards will be loaded dynamically -->
                </div>
                <div class="chart-container" id="adminChart">
                    <div class="chart-title">Reports Overview</div>
                    <div class="chart-grid" id="adminChartGrid"></div>
                </div>
                <div class="table-container" id="recentReportsContainer">
                    <!-- Recent reports table -->
                </div>
            </div>

            <!-- Admin Reports Management -->
            <div id="adminReports" class="content-section">
                <div class="table-container">
                    <div class="table-header">
                        <h3>üìã All Reports</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="exportReports('csv')">üì• Export CSV</button>
                            <input type="text" class="search-box" placeholder="Search reports..." 
                                   onkeyup="debouncedFilterReports(this.value)" aria-label="Search reports">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <div id="reportsTableContainer"></div>
                    </div>
                    <div id="reportsPagination" class="pagination"></div>
                </div>
            </div>

            <!-- Admin User Management -->
            <div id="adminUsers" class="content-section">
                <div class="table-container">
                    <div class="table-header">
                        <h3>üë• User Management</h3>
                        <button class="btn btn-primary" onclick="showAddUserModal()">
                            ‚ûï Add User
                        </button>
                    </div>
                    <div class="table-responsive">
                        <div id="usersTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Admin Analytics -->
            <div id="adminAnalytics" class="content-section">
                <div class="stats-grid" id="analyticsStats"></div>
                <div class="chart-container">
                    <div class="chart-title">Reports by Status</div>
                    <div class="chart-grid" id="statusChart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Reports by Type</div>
                    <div class="chart-grid" id="typeChart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Monthly Report Trends</div>
                    <div class="chart-grid" id="monthlyChart"></div>
                </div>
            </div>

            <!-- User Dashboard -->
            <div id="userDashboard" class="content-section">
                <div class="stats-grid" id="userStatsGrid">
                    <!-- User stats -->
                </div>
                <div class="chart-container">
                    <div class="chart-title">My Report Status</div>
                    <div class="chart-grid" id="userChartGrid"></div>
                </div>
            </div>

            <!-- Submit Report (User) -->
            <div id="submitReport" class="content-section">
                <div class="form-card">
                    <h2 style="color: var(--primary-color); margin-bottom: 25px;">üìù Submit New Report</h2>
                    <form id="reportForm" onsubmit="return false;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Report Date <span class="required">*</span></label>
                                <input type="date" id="reportDate" required aria-required="true">
                                <div class="error-message" id="error-reportDate"></div>
                            </div>
                            <div class="form-group">
                                <label>Report Type <span class="required">*</span></label>
                                <select id="reportType" required aria-required="true">
                                    <option value="">Select Type</option>
                                    <option value="daily">Daily Report</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="incident">Incident</option>
                                    <option value="fuel">Fuel Report</option>
                                </select>
                                <div class="error-message" id="error-reportType"></div>
                            </div>
                            <div class="form-group">
                                <label>Vehicle Number <span class="required">*</span></label>
                                <input type="text" id="vehicleNumber" placeholder="e.g., ABC-1234" 
                                       pattern="[A-Z]{3}-\d{4}" required aria-required="true">
                                <div class="error-message" id="error-vehicleNumber"></div>
                            </div>
                            <div class="form-group">
                                <label>Odometer Reading (km) <span class="required">*</span></label>
                                <input type="number" id="odometer" min="0" placeholder="Current reading" required>
                                <div class="error-message" id="error-odometer"></div>
                            </div>
                            <div class="form-group">
                                <label>Fuel Amount (liters)</label>
                                <input type="number" id="fuelAmount" min="0" step="0.1" placeholder="Fuel consumed">
                            </div>
                            <div class="form-group">
                                <label>Expenses (SAR)</label>
                                <input type="number" id="expenses" min="0" step="0.01" placeholder="Total expenses">
                            </div>
                            <div class="form-group full-width">
                                <label>Route/Location</label>
                                <input type="text" id="route" placeholder="e.g., Riyadh to Jeddah">
                            </div>
                            <div class="form-group full-width">
                                <label>Description/Notes <span class="required">*</span></label>
                                <textarea id="reportNotes" placeholder="Enter detailed description..." required></textarea>
                                <div class="error-message" id="error-reportNotes"></div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; margin-top: 25px;">
                            <button type="button" class="btn btn-primary" style="flex: 1;" onclick="submitReport()">
                                ‚úì Submit Report
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetReportForm()">
                                ‚Ü∫ Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- My Reports (User) -->
            <div id="myReports" class="content-section">
                <div class="table-container">
                    <div class="table-header">
                        <h3>üìã My Reports</h3>
                        <input type="text" class="search-box" placeholder="Search my reports..." 
                               onkeyup="debouncedFilterMyReports(this.value)" aria-label="Search my reports">
                    </div>
                    <div class="table-responsive">
                        <div id="myReportsTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- ===== TICKET SUBMISSION (Driver Supervisor) ===== -->
            <div id="submitTicket" class="content-section">
                <div class="form-card" style="max-width: 900px;">
                    <h2 style="color: var(--primary-color); margin-bottom: 8px;">üé´ Raise New Request</h2>
                    <p style="color:#777; margin-bottom: 24px; font-size:14px;">Select a request type to get started. It will be sent to Admin for approval.</p>

                    <!-- Step indicator -->
                    <div class="step-indicator">
                        <div class="step-dot active" id="sdot1">1</div>
                        <div class="step-line" id="sline1"></div>
                        <div class="step-dot" id="sdot2">2</div>
                        <div class="step-line" id="sline2"></div>
                        <div class="step-dot" id="sdot3">3</div>
                    </div>

                    <!-- Step 1: Choose type -->
                    <div id="ticketStep1" class="ticket-form-step active">
                        <h3 style="margin-bottom:16px; font-size:15px; color:#555;">Step 1: Choose Request Type</h3>
                        <div class="ticket-type-grid">
                            <div class="ticket-type-card" onclick="selectTicketType('maintenance')" id="ttype-maintenance">
                                <div class="ticket-icon">üîß</div>
                                <div class="ticket-label">Maintenance Request</div>
                                <div style="font-size:11px; color:#888; margin-top:5px;">Vehicle repair & service</div>
                            </div>
                            <div class="ticket-type-card" onclick="selectTicketType('fuel')" id="ttype-fuel">
                                <div class="ticket-icon">‚õΩ</div>
                                <div class="ticket-label">Fuel Request</div>
                                <div style="font-size:11px; color:#888; margin-top:5px;">Fuel amount approval</div>
                            </div>
                            <div class="ticket-type-card" onclick="selectTicketType('leave')" id="ttype-leave">
                                <div class="ticket-icon">üèñÔ∏è</div>
                                <div class="ticket-label">Leave Request</div>
                                <div style="font-size:11px; color:#888; margin-top:5px;">Driver leave / absence</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <button class="btn btn-primary" onclick="ticketNextStep(2)" id="ticketStep1Btn" disabled>Next ‚Üí</button>
                        </div>
                    </div>

                    <!-- Step 2: Fill form -->
                    <div id="ticketStep2" class="ticket-form-step">
                        <h3 style="margin-bottom:16px; font-size:15px; color:#555;" id="ticketFormTitle">Step 2: Request Details</h3>

                        <!-- MAINTENANCE fields -->
                        <div id="ticketFields-maintenance" style="display:none;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Driver Name <span class="required">*</span></label>
                                    <input type="text" id="t-maint-driver" placeholder="Driver full name" required>
                                </div>
                                <div class="form-group">
                                    <label>Vehicle Number <span class="required">*</span></label>
                                    <input type="text" id="t-maint-vehicle" placeholder="e.g. ABC-1234">
                                </div>
                                <div class="form-group">
                                    <label>Maintenance Type <span class="required">*</span></label>
                                    <select id="t-maint-type">
                                        <option value="">Select type</option>
                                        <option value="oil_change">Oil Change</option>
                                        <option value="tire_change">Tire Change</option>
                                        <option value="brake_service">Brake Service</option>
                                        <option value="engine_repair">Engine Repair</option>
                                        <option value="ac_repair">A/C Repair</option>
                                        <option value="electrical">Electrical Issue</option>
                                        <option value="body_repair">Body Repair</option>
                                        <option value="periodic_service">Periodic Service</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Estimated Cost (SAR) <span class="required">*</span></label>
                                    <input type="number" id="t-maint-cost" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                                <div class="form-group">
                                    <label>Priority <span class="required">*</span></label>
                                    <select id="t-maint-priority">
                                        <option value="low">üü¢ Low</option>
                                        <option value="medium" selected>üü° Medium</option>
                                        <option value="high">üü† High</option>
                                        <option value="urgent">üî¥ Urgent</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Requested Date</label>
                                    <input type="date" id="t-maint-date">
                                </div>
                                <div class="form-group full-width">
                                    <label>Description / Notes <span class="required">*</span></label>
                                    <textarea id="t-maint-notes" placeholder="Describe the issue in detail..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- FUEL fields -->
                        <div id="ticketFields-fuel" style="display:none;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Driver Name <span class="required">*</span></label>
                                    <input type="text" id="t-fuel-driver" placeholder="Driver full name" required>
                                </div>
                                <div class="form-group">
                                    <label>Vehicle Number <span class="required">*</span></label>
                                    <input type="text" id="t-fuel-vehicle" placeholder="e.g. ABC-1234">
                                </div>
                                <div class="form-group">
                                    <label>Fuel Amount (Liters) <span class="required">*</span></label>
                                    <input type="number" id="t-fuel-liters" min="1" step="0.1" placeholder="0.0" required>
                                </div>
                                <div class="form-group">
                                    <label>Estimated Cost (SAR) <span class="required">*</span></label>
                                    <input type="number" id="t-fuel-cost" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                                <div class="form-group">
                                    <label>Fuel Station</label>
                                    <input type="text" id="t-fuel-station" placeholder="Station name / location">
                                </div>
                                <div class="form-group">
                                    <label>Required Date <span class="required">*</span></label>
                                    <input type="date" id="t-fuel-date" required>
                                </div>
                                <div class="form-group full-width">
                                    <label>Reason / Notes <span class="required">*</span></label>
                                    <textarea id="t-fuel-notes" placeholder="Reason for fuel request..." required></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- LEAVE fields -->
                        <div id="ticketFields-leave" style="display:none;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Driver Name <span class="required">*</span></label>
                                    <input type="text" id="t-leave-driver" placeholder="Driver full name" required>
                                </div>
                                <div class="form-group">
                                    <label>Leave Type <span class="required">*</span></label>
                                    <select id="t-leave-type">
                                        <option value="">Select type</option>
                                        <option value="annual">Annual Leave</option>
                                        <option value="sick">Sick Leave</option>
                                        <option value="emergency">Emergency Leave</option>
                                        <option value="unpaid">Unpaid Leave</option>
                                        <option value="hajj">Hajj Leave</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>From Date <span class="required">*</span></label>
                                    <input type="date" id="t-leave-from">
                                </div>
                                <div class="form-group">
                                    <label>To Date <span class="required">*</span></label>
                                    <input type="date" id="t-leave-to">
                                </div>
                                <div class="form-group">
                                    <label>Number of Days</label>
                                    <input type="number" id="t-leave-days" min="1" placeholder="Auto calculated" readonly
                                           style="background:#f5f5f5;">
                                </div>
                                <div class="form-group">
                                    <label>Replacement Driver</label>
                                    <input type="text" id="t-leave-replacement" placeholder="Replacement driver name (if any)">
                                </div>
                                <div class="form-group full-width">
                                    <label>Reason / Notes <span class="required">*</span></label>
                                    <textarea id="t-leave-notes" placeholder="Reason for leave request..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div style="display:flex; gap:10px; margin-top:20px; justify-content:space-between;">
                            <button class="btn btn-secondary" onclick="ticketNextStep(1)">‚Üê Back</button>
                            <button class="btn btn-primary" onclick="ticketNextStep(3)">Preview ‚Üí</button>
                        </div>
                    </div>

                    <!-- Step 3: Preview & Submit -->
                    <div id="ticketStep3" class="ticket-form-step">
                        <h3 style="margin-bottom:16px; font-size:15px; color:#555;">Step 3: Review & Submit</h3>
                        <div id="ticketPreview" style="background:#f8f9ff; border:1px solid #c5cae9; border-radius:12px; padding:20px; margin-bottom:20px;"></div>
                        <div style="background:#fff8e1; border:1px solid #ffe082; border-radius:10px; padding:12px 16px; font-size:13px; color:#555; margin-bottom:20px;">
                            ‚ö†Ô∏è This request will be sent to <strong>Admin</strong> for approval. You will see the status in "My Requests".
                        </div>
                        <div style="display:flex; gap:10px; justify-content:space-between;">
                            <button class="btn btn-secondary" onclick="ticketNextStep(2)">‚Üê Edit</button>
                            <button class="btn btn-primary" onclick="submitTicket()" style="min-width:160px;">
                                üì§ Send Request
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== MY TICKETS (Driver Supervisor) ===== -->
            <div id="myTickets" class="content-section">
                <div class="table-container">
                    <div class="table-header">
                        <h3>üé´ My Requests</h3>
                        <input type="text" class="search-box" placeholder="Search tickets..."
                               onkeyup="filterMyTickets(this.value)" aria-label="Search tickets">
                    </div>
                    <div class="table-responsive">
                        <div id="myTicketsTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- ===== FINANCIAL DASHBOARD (Accountant - View Only) ===== -->
            <div id="financialDashboard" class="content-section">
                <h2 style="color: var(--primary-color); margin-bottom: 20px;">üí∞ Financial Dashboard</h2>
                
                <!-- Summary Cards -->
                <div class="summary-grid" id="financialSummary">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Financial Overview (View Only) -->
                <div class="table-container" style="margin-top: 30px;">
                    <div class="table-header">
                        <h3>üìä Financial Overview</h3>
                        <div style="display:flex; gap:10px;">
                            <select id="financialTypeFilter" class="search-box" style="width:160px;" onchange="loadFinancialDashboard()">
                                <option value="">All Types</option>
                                <option value="maintenance">üîß Maintenance</option>
                                <option value="fuel">‚õΩ Fuel</option>
                                <option value="report">üìã Expense Reports</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <div id="financialTableContainer"></div>
                    </div>
                </div>

                <!-- Financial Analytics -->
                <div class="chart-container" style="margin-top: 30px;">
                    <div class="chart-title">Monthly Financial Overview</div>
                    <div class="chart-grid" id="financialChartGrid"></div>
                </div>
            </div>

            <!-- ===== SALES & MARKETING DASHBOARD ===== -->
            <div id="salesDashboard" class="content-section">
                <h2 style="color: var(--primary-color); margin-bottom: 20px;">üìä Sales & Marketing Dashboard</h2>
                
                <!-- Summary Cards -->
                <div class="summary-grid" id="salesSummary">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Campaign/Event Requests -->
                <div class="table-container" style="margin-top: 30px;">
                    <div class="table-header">
                        <h3>üéØ Campaign & Event Requests</h3>
                        <button class="btn btn-primary" onclick="showCampaignRequestModal()">‚ûï New Campaign Request</button>
                    </div>
                    <div class="table-responsive">
                        <div id="campaignRequestsTable"></div>
                    </div>
                </div>

                <!-- Marketing Reports -->
                <div class="chart-container" style="margin-top: 30px;">
                    <div class="chart-title">Marketing ROI Overview</div>
                    <div class="chart-grid" id="roiChartGrid"></div>
                </div>
            </div>

            <!-- ===== ADMIN TICKET MANAGEMENT (Admin Only) ===== -->
            <div id="adminTickets" class="content-section">
                <div class="table-container">
                    <div class="table-header">
                        <h3>üé´ Request Management (Admin Only)</h3>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <select id="ticketTypeFilter" class="search-box" style="width:160px;" onchange="loadAdminTickets()">
                                <option value="">All Types</option>
                                <option value="maintenance">üîß Maintenance</option>
                                <option value="fuel">‚õΩ Fuel</option>
                                <option value="leave">üèñÔ∏è Leave</option>
                            </select>
                            <select id="ticketStatusFilter" class="search-box" style="width:150px;" onchange="loadAdminTickets()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <div id="adminTicketsTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Campaign Request Modal -->
            <div id="campaignModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="campaignModalTitle">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 id="campaignModalTitle">üéØ New Campaign Request</h3>
                        <button class="close-btn" onclick="closeModal('campaignModal')" aria-label="Close">&times;</button>
                    </div>
                    <form onsubmit="saveCampaignRequest(event)">
                        <input type="hidden" id="campaignId">
                        <div class="form-group">
                            <label>Campaign Name <span class="required">*</span></label>
                            <input type="text" id="campaignName" required>
                        </div>
                        <div class="form-group">
                            <label>Campaign Type <span class="required">*</span></label>
                            <select id="campaignType" required>
                                <option value="">Select type</option>
                                <option value="digital">üì± Digital Marketing</option>
                                <option value="print">üñ®Ô∏è Print Media</option>
                                <option value="event">üé™ Event/Exhibition</option>
                                <option value="social">üì≤ Social Media</option>
                                <option value="promotion">üéÅ Special Promotion</option>
                                <option value="other">üìå Other</option>
                            </select>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Budget (SAR) <span class="required">*</span></label>
                                <input type="number" id="campaignBudget" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Start Date <span class="required">*</span></label>
                                <input type="date" id="campaignStartDate" required>
                            </div>
                            <div class="form-group">
                                <label>End Date <span class="required">*</span></label>
                                <input type="date" id="campaignEndDate" required>
                            </div>
                            <div class="form-group">
                                <label>Expected ROI (%)</label>
                                <input type="number" id="campaignRoi" min="0" step="0.1" placeholder="e.g., 150">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Target Audience</label>
                            <input type="text" id="campaignTarget" placeholder="e.g., Corporate clients, SME">
                        </div>
                        <div class="form-group full-width">
                            <label>Description / Objectives <span class="required">*</span></label>
                            <textarea id="campaignDescription" rows="3" required></textarea>
                        </div>
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">Submit Request</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('campaignModal')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Report Details Modal -->
    <div id="reportModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="reportModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="reportModalTitle">Report Details</h3>
                <button class="close-btn" onclick="closeModal('reportModal')" aria-label="Close">&times;</button>
            </div>
            <div id="reportDetails"></div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Add User</h3>
                <button class="close-btn" onclick="closeModal('userModal')" aria-label="Close">&times;</button>
            </div>
            <form onsubmit="saveUser(event)">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>Username <span class="required">*</span></label>
                    <input type="text" id="userUsername" required>
                </div>
                <div class="form-group">
                    <label>Full Name <span class="required">*</span></label>
                    <input type="text" id="userFullName" required>
                </div>
                <div class="form-group">
                    <label>Email <span class="required">*</span></label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label>Password <span class="required" id="passwordRequired">*</span></label>
                    <input type="password" id="userPassword" minlength="6">
                </div>
                <div class="form-group">
                    <label>Role <span class="required">*</span></label>
                    <select id="userRole" required>
                        <option value="driver">üöó Driver</option>
                        <option value="driver_supervisor">üö¶ Driver Supervisor</option>
                        <option value="maintenance_supervisor">üî© Maintenance Supervisor</option>
                        <option value="vehicle_engineer">üîß Vehicle Engineer</option>
                        <option value="supervisor">üë∑ Supervisor</option>
                        <option value="accountant">üßæ Accountant</option>
                        <option value="sales_marketing">üì£ Sales & Marketing</option>
                        <option value="hr">üßë‚Äçüíº HR</option>
                        <option value="manager">üëî Manager</option>
                        <option value="executive">üíº Executive</option>
                        <option value="admin">üõ°Ô∏è Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status <span class="required">*</span></label>
                    <select id="userStatus" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save User</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div id="ticketModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="ticketModalTitle">
        <div class="modal-content" style="max-width:620px;">
            <div class="modal-header">
                <h3 id="ticketModalTitle">üé´ Request Details</h3>
                <button class="close-btn" onclick="closeModal('ticketModal')" aria-label="Close">&times;</button>
            </div>
            <div id="ticketDetailContent"></div>
            <div id="ticketApprovalActions" style="display:none; margin-top:20px;"></div>
        </div>
    </div>

    <!-- Financial Detail Modal (View Only) -->
    <div id="financialModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="financialModalTitle">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <h3 id="financialModalTitle">üí∞ Financial Details</h3>
                <button class="close-btn" onclick="closeModal('financialModal')" aria-label="Close">&times;</button>
            </div>
            <div id="financialDetailContent"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
        <div class="modal-content" style="max-width: 540px;">
            <div class="modal-header">
                <h3 id="settingsModalTitle">‚öôÔ∏è Settings</h3>
                <button class="close-btn" onclick="closeModal('settingsModal')" aria-label="Close">&times;</button>
            </div>

            <!-- Google Sheets Section -->
            <div class="settings-section">
                <h4>üîó Google Sheets Sync</h4>
                <div class="sync-info-box">
                    <strong>How to set up:</strong>
                    <ol>
                        <li>Open <a href="https://script.google.com" target="_blank">script.google.com</a> ‚Üí New project</li>
                        <li>Paste the provided <code>rihlati_google_apps_script.gs</code> code</li>
                        <li>Click <strong>Deploy ‚Üí New deployment</strong></li>
                        <li>Type: <code>Web app</code> ¬∑ Execute as: <code>Me</code> ¬∑ Access: <code>Anyone</code></li>
                        <li>Copy the <strong>Web App URL</strong> and paste it below</li>
                    </ol>
                </div>
                <div class="form-group" style="margin-top: 14px; margin-bottom: 6px;">
                    <label style="font-size: 13px; color: var(--primary-color); font-weight: 600;">Web App URL</label>
                    <input type="url" id="sheetsUrlInput" class="sheet-url-input"
                           placeholder="https://script.google.com/macros/s/AKfy.../exec"
                           oninput="validateSheetsUrl(this)">
                </div>
                <p id="sheetsUrlFeedback" class="sync-last-time"></p>
                <div style="display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="saveSheetsUrl()" style="flex: 1;">üíæ Save & Connect</button>
                    <button class="btn btn-secondary" onclick="testSheetsConnection()" style="flex: 1;">üîå Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectSheets()" style="flex: 1;" id="disconnectBtn">üóëÔ∏è Disconnect</button>
                </div>
                <div id="syncActions" style="margin-top: 14px; display: none; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="syncFromSheets()" style="flex:1;">‚¨áÔ∏è Pull from Sheets</button>
                    <button class="btn btn-primary"  onclick="syncToSheets()"   style="flex:1;">‚¨ÜÔ∏è Push to Sheets</button>
                </div>
                <p id="lastSyncTime" class="sync-last-time"></p>
            </div>

            <!-- Auto sync toggle -->
            <div class="settings-section" style="margin-bottom: 0;">
                <h4>üîÑ Auto Sync</h4>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 14px; color: #555;">Sync automatically every 5 minutes</span>
                    <label style="position:relative; display:inline-block; width:48px; height:26px; cursor:pointer;">
                        <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync(this.checked)"
                               style="opacity:0; width:0; height:0;">
                        <span id="autoSyncSlider" style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
                              background:#ccc; border-radius:26px; transition:.3s;">
                            <span id="autoSyncThumb" style="position:absolute; height:20px; width:20px; left:3px; bottom:3px;
                                  background:white; border-radius:50%; transition:.3s;"></span>
                        </span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" role="alert">
        <span id="toastIcon">‚úì</span>
        <span id="toastMessage">Success!</span>
    </div>

    <script>
        // ==================== UTILITY FUNCTIONS ====================
        const Utils = {
            showLoading(show = true) {
                document.getElementById('globalLoader').style.display = show ? 'flex' : 'none';
            },

            formatDate(date, format = 'short') {
                const d = new Date(date);
                if (isNaN(d.getTime())) return 'Invalid Date';
                
                if (format === 'short') {
                    return d.toLocaleDateString('en-SA', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
                return d.toLocaleString('en-SA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            formatCurrency(amount) {
                return new Intl.NumberFormat('en-SA', {
                    style: 'currency',
                    currency: 'SAR',
                    minimumFractionDigits: 2
                }).format(amount || 0);
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            validateVehicleNumber(vehicleNumber) {
                const vehicleRegex = /^[A-Z]{3}-\d{4}$/;
                return vehicleRegex.test(vehicleNumber);
            },

            hashPassword: async (password) => {
                const msgBuffer = new TextEncoder().encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            },

            generateId(items) {
                return items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1;
            },

            showToast(message, isError = false, duration = 3000) {
                const toast = document.getElementById('toast');
                document.getElementById('toastMessage').textContent = message;
                document.getElementById('toastIcon').textContent = isError ? '‚ùå' : '‚úì';
                toast.className = 'toast' + (isError ? ' error' : '');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), duration);
            },

            escapeHTML(str) {
                if (str === null || str === undefined) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            },

            async safeAsync(fn, errorMessage = 'Operation failed') {
                try {
                    this.showLoading(true);
                    return await fn();
                } catch (error) {
                    console.error(error);
                    this.showToast(`${errorMessage}: ${error.message}`, true);
                } finally {
                    this.showLoading(false);
                }
            },

            isAdmin() {
                return AppState.currentUser && AppState.currentUser.role === 'admin';
            }
        };

        // ==================== DATA SERVICE ====================
        const DataService = {
            // ---- localStorage helpers ----
            getData() {
                const stored = localStorage.getItem('fleetManagementData');
                return stored ? JSON.parse(stored) : null;
            },
            saveData(data) {
                localStorage.setItem('fleetManagementData', JSON.stringify(data));
            },
            getUsers()   { return this.getData()?.users   || []; },
            getReports() { return this.getData()?.reports || []; },
            getVehicles(){ return this.getData()?.vehicles|| []; },
            saveUsers(users) {
                const d = this.getData() || {};
                d.users = users;
                this.saveData(d);
            },
            saveReports(reports) {
                const d = this.getData() || {};
                d.reports = reports;
                this.saveData(d);
            },
            saveVehicles(vehicles) {
                const d = this.getData() || {};
                d.vehicles = vehicles;
                this.saveData(d);
            },
            getTickets() { return this.getData()?.tickets || []; },
            saveTickets(tickets) {
                const d = this.getData() || {};
                d.tickets = tickets;
                this.saveData(d);
            },
            getCampaigns() { return this.getData()?.campaigns || []; },
            saveCampaigns(campaigns) {
                const d = this.getData() || {};
                d.campaigns = campaigns;
                this.saveData(d);
            },

            // ---- Google Sheets helpers ----
            getSheetsUrl()  { return localStorage.getItem('rihlatiSheetsUrl') || ''; },
            setSheetsUrl(u) { localStorage.setItem('rihlatiSheetsUrl', u); },
            clearSheetsUrl(){ localStorage.removeItem('rihlatiSheetsUrl'); },
            getLastSync()   { return localStorage.getItem('rihlatiLastSync') || ''; },
            setLastSync()   { localStorage.setItem('rihlatiLastSync', new Date().toISOString()); },
            isLinked()      { return !!this.getSheetsUrl(); },

            async sheetsGet(action) {
                const url = this.getSheetsUrl();
                if (!url) throw new Error('No Google Sheets URL configured');
                const res = await fetch(`${url}?action=${action}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                if (json.error) throw new Error(json.error);
                return json;
            },

            async sheetsPost(payload) {
                const url = this.getSheetsUrl();
                if (!url) throw new Error('No Google Sheets URL configured');
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' }, // avoid CORS preflight
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                if (json.error) throw new Error(json.error);
                return json;
            },

            // Pull all data from Sheets ‚Üí overwrite localStorage
            async pullFromSheets() {
                const remote = await this.sheetsGet('getAll');
                const local  = this.getData() || {};
                local.users   = remote.users   || local.users   || [];
                local.reports = remote.reports || local.reports || [];
                this.saveData(local);
                this.setLastSync();
                return { users: local.users.length, reports: local.reports.length };
            },

            // Push localStorage data ‚Üí Sheets
            async pushToSheets() {
                const local = this.getData() || {};
                const result = await this.sheetsPost({
                    action:  'saveAll',
                    users:   local.users   || [],
                    reports: local.reports || [],
                    campaigns: local.campaigns || []
                });
                this.setLastSync();
                return result;
            },

            // Test connection
            async ping() {
                const result = await this.sheetsGet('ping');
                return result.ok === true;
            },

            initializeDefaultData() {
                const DATA_VERSION = 7;
                const existing = this.getData();
                if (existing && existing.version === DATA_VERSION) return existing;

                const defaultData = {
                    version: DATA_VERSION,
                    users: [
                        {
                            id: 1,
                            username: 'admin',
                            password: '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918', // admin
                            name: 'Admin User',
                            email: 'admin@rihlati.com',
                            role: 'admin',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 2,
                            username: 'manager1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Fahad Al-Otaibi',
                            email: 'fahad@rihlati.com',
                            role: 'manager',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 3,
                            username: 'supervisor1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Nasser Al-Ghamdi',
                            email: 'nasser@rihlati.com',
                            role: 'supervisor',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 4,
                            username: 'drvsupervisor1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Walid Al-Qahtani',
                            email: 'walid@rihlati.com',
                            role: 'driver_supervisor',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 5,
                            username: 'maintsupervisor1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Rami Al-Dosari',
                            email: 'rami@rihlati.com',
                            role: 'maintenance_supervisor',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 6,
                            username: 'hr1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Sara Al-Zahrani',
                            email: 'sara@rihlati.com',
                            role: 'hr',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 7,
                            username: 'accountant1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Lina Al-Rashidi',
                            email: 'lina@rihlati.com',
                            role: 'accountant',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 8,
                            username: 'sales1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Yousef Al-Malki',
                            email: 'yousef@rihlati.com',
                            role: 'sales_marketing',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 9,
                            username: 'exec1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Tariq Al-Harbi',
                            email: 'tariq@rihlati.com',
                            role: 'executive',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 10,
                            username: 'engineer1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Omar Al-Shehri',
                            email: 'omar@rihlati.com',
                            role: 'vehicle_engineer',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 11,
                            username: 'driver1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Ahmed Mohammed',
                            email: 'ahmed@rihlati.com',
                            role: 'driver',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 12,
                            username: 'driver2',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Khalid Ali',
                            email: 'khalid@rihlati.com',
                            role: 'driver',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        }
                    ],
                    reports: [
                        {
                            id: 1,
                            userId: 2,
                            driverName: 'Ahmed Mohammed',
                            date: '2026-02-15',
                            type: 'daily',
                            vehicleNumber: 'ABC-1234',
                            odometer: 45000,
                            fuel: 45.5,
                            expenses: 250,
                            route: 'Riyadh to Medina',
                            notes: 'Regular daily route. No issues.',
                            status: 'approved',
                            submittedAt: '2026-02-15T08:30:00',
                            reviewedAt: '2026-02-15T10:00:00'
                        },
                        {
                            id: 2,
                            userId: 3,
                            driverName: 'Khalid Ali',
                            date: '2026-02-15',
                            type: 'maintenance',
                            vehicleNumber: 'XYZ-5678',
                            odometer: 32000,
                            fuel: 0,
                            expenses: 450,
                            route: 'Service Center',
                            notes: 'Oil change and tire rotation completed.',
                            status: 'pending',
                            submittedAt: '2026-02-15T14:20:00'
                        }
                    ],
                    vehicles: [],
                    tickets: [
                        {
                            id: 1,
                            type: 'maintenance',
                            submittedBy: 4,
                            submitterName: 'Walid Al-Qahtani',
                            submitterRole: 'driver_supervisor',
                            driverName: 'Ahmed Mohammed',
                            vehicle: 'ABC-1234',
                            maintType: 'oil_change',
                            cost: 450,
                            priority: 'high',
                            requestedDate: '2026-02-20',
                            notes: 'Engine oil needs urgent change',
                            status: 'pending',
                            submittedAt: '2026-02-15T16:30:00'
                        },
                        {
                            id: 2,
                            type: 'fuel',
                            submittedBy: 4,
                            submitterName: 'Walid Al-Qahtani',
                            submitterRole: 'driver_supervisor',
                            driverName: 'Khalid Ali',
                            vehicle: 'XYZ-5678',
                            liters: 80,
                            cost: 240,
                            station: 'Al-Dabab Station',
                            requestedDate: '2026-02-16',
                            notes: 'Need fuel for long trip',
                            status: 'pending',
                            submittedAt: '2026-02-15T17:00:00'
                        }
                    ],
                    campaigns: [
                        {
                            id: 1,
                            name: 'Summer Fleet Promotion',
                            type: 'digital',
                            budget: 5000,
                            startDate: '2026-03-01',
                            endDate: '2026-03-31',
                            expectedRoi: 150,
                            targetAudience: 'Corporate clients',
                            description: 'Digital campaign targeting corporate sector',
                            status: 'pending',
                            submittedBy: 8,
                            submitterName: 'Yousef Al-Malki',
                            submittedAt: '2026-02-14T10:00:00'
                        }
                    ]
                };

                this.saveData(defaultData);
                return defaultData;
            }
        };

        // ==================== APPLICATION STATE ====================
        const AppState = {
            currentUser: null,
            data: DataService.initializeDefaultData(),
            sessionTimeout: 30 * 60 * 1000, // 30 minutes
            lastActivity: Date.now(),

            get users() { return this.data.users; },
            set users(value) { 
                this.data.users = value;
                DataService.saveUsers(value);
                if (DataService.isLinked() && this.currentUser?.role === 'admin') syncToSheets();
            },

            get reports() { return this.data.reports; },
            set reports(value) { 
                this.data.reports = value;
                DataService.saveReports(value);
                if (DataService.isLinked() && this.currentUser?.role === 'admin') syncToSheets();
            },

            get vehicles() { return this.data.vehicles; },
            set vehicles(value) { 
                this.data.vehicles = value;
                DataService.saveVehicles(value);
            },

            get tickets() { return this.data.tickets || []; },
            set tickets(value) {
                this.data.tickets = value;
                DataService.saveTickets(value);
            },

            get campaigns() { return this.data.campaigns || []; },
            set campaigns(value) {
                this.data.campaigns = value;
                DataService.saveCampaigns(value);
            },

            updateActivity() {
                this.lastActivity = Date.now();
            },

            checkSession() {
                if (this.currentUser && Date.now() - this.lastActivity > this.sessionTimeout) {
                    logout();
                    Utils.showToast('Session expired. Please login again.', true);
                    return false;
                }
                return true;
            }
        };

        // ==================== ROLE PERMISSIONS ====================
        const ROLES = {
            admin: {
                label: 'Administrator', labelAr: 'ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ', icon: 'üõ°Ô∏è',
                color: '#1976d2', bg: '#e3f2fd',
                nav: ['dashboard', 'reports', 'users', 'analytics', 'tickets', 'financial'],
                canApprove: true, canReject: true, canManageUsers: true,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: true, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: true, canManageFinancial: true, canManageCampaigns: true,
            },
            manager: {
                label: 'Manager', labelAr: 'ŸÖÿØŸäÿ±', icon: 'üëî',
                color: '#6a1b9a', bg: '#f3e5f5',
                nav: ['dashboard', 'reports', 'analytics'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: true, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            supervisor: {
                label: 'Supervisor', labelAr: 'ŸÖÿ¥ÿ±ŸÅ', icon: 'üë∑',
                color: '#e65100', bg: '#fff3e0',
                nav: ['dashboard', 'reports'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: false, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            driver_supervisor: {
                label: 'Driver Supervisor', labelAr: 'ŸÖÿ¥ÿ±ŸÅ ÿßŸÑÿ≥ÿßÿ¶ŸÇŸäŸÜ', icon: 'üö¶',
                color: '#1565c0', bg: '#e3f2fd',
                nav: ['dashboard', 'reports', 'tickets', 'myTickets'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: false, canViewMyReports: false,
                canSubmitTicket: true, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            maintenance_supervisor: {
                label: 'Maintenance Supervisor', labelAr: 'ŸÖÿ¥ÿ±ŸÅ ÿßŸÑÿµŸäÿßŸÜÿ©', icon: 'üî©',
                color: '#4e342e', bg: '#efebe9',
                nav: ['dashboard', 'reports', 'submit', 'myReports', 'tickets', 'myTickets'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: true, canViewAllReports: true, canViewAnalytics: false, canViewMyReports: true,
                canSubmitTicket: true, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            hr: {
                label: 'HR', labelAr: 'ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑÿ®ÿ¥ÿ±Ÿäÿ©', icon: 'üßë‚Äçüíº',
                color: '#00695c', bg: '#e0f2f1',
                nav: ['dashboard', 'users', 'reports'],
                canApprove: false, canReject: false, canManageUsers: true,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: false, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            accountant: {
                label: 'Accountant', labelAr: 'ŸÖÿ≠ÿßÿ≥ÿ®', icon: 'üßæ',
                color: '#2e7d32', bg: '#e8f5e9',
                nav: ['dashboard', 'reports', 'analytics', 'financial'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: true, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            sales_marketing: {
                label: 'Sales & Marketing', labelAr: 'ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ŸàÿßŸÑÿ™ÿ≥ŸàŸäŸÇ', icon: 'üì£',
                color: '#ad1457', bg: '#fce4ec',
                nav: ['dashboard', 'reports', 'analytics', 'sales'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: true, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: true,
                canCreateCampaign: true
            },
            executive: {
                label: 'Executive', labelAr: 'ÿ™ŸÜŸÅŸäÿ∞Ÿä', icon: 'üíº',
                color: '#b71c1c', bg: '#ffebee',
                nav: ['dashboard', 'reports', 'analytics'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: true, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            vehicle_engineer: {
                label: 'Vehicle Engineer', labelAr: 'ŸÖŸáŸÜÿØÿ≥ ÿßŸÑŸÖÿ±ŸÉÿ®ÿßÿ™', icon: 'üîß',
                color: '#37474f', bg: '#eceff1',
                nav: ['dashboard', 'submit', 'myReports', 'reports'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: true, canViewAllReports: true, canViewAnalytics: false, canViewMyReports: true,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            driver: {
                label: 'Driver', labelAr: 'ÿ≥ÿßÿ¶ŸÇ', icon: 'üöó',
                color: '#f57f17', bg: '#fffde7',
                nav: ['dashboard', 'submit', 'myReports'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: true, canViewAllReports: false, canViewAnalytics: false, canViewMyReports: true,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            }
        };

        function getRoleInfo(role) {
            return ROLES[role] || ROLES['driver'];
        }

        // ==================== SESSION MANAGEMENT ====================
        document.addEventListener('click', () => AppState.updateActivity());
        document.addEventListener('keypress', () => AppState.updateActivity());
        document.addEventListener('scroll', () => AppState.updateActivity());

        setInterval(() => {
            AppState.checkSession();
        }, 60000);

        // ==================== DEBOUNCED FUNCTIONS ====================
        const debouncedFilterReports = Utils.debounce((term) => {
            filterReports(term);
        }, 300);

        const debouncedFilterMyReports = Utils.debounce((term) => {
            filterMyReports(term);
        }, 300);

        // ==================== AUTHENTICATION ====================
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span>Logging in...</span>';
            
            try {
                const hashedPassword = await Utils.hashPassword(password);
                const user = AppState.users.find(u => 
                    u.username === username && 
                    u.password === hashedPassword && 
                    u.status === 'active'
                );
                
                if (user) {
                    AppState.currentUser = user;
                    sessionStorage.setItem('rihlatiSession', JSON.stringify({ userId: user.id }));
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('appContainer').classList.add('show');
                    
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('sidebarUserRole').textContent = getRoleInfo(user.role).label;
                    document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
                    
                    loadInterface();
                    
                    Utils.showToast(t('welcomeBack', user.name));
                } else {
                    Utils.showToast('Invalid credentials. Please try again.', true);
                }
            } catch (error) {
                Utils.showToast('Login failed. Please try again.', true);
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span>Sign In</span>';
            }
        }

        // ==================== MOBILE MENU ====================
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('menuOverlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('show');
        }

        // ==================== NAVIGATION ====================
        function navigateTo(sectionId, title, element) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            element.classList.add('active');
            document.getElementById('currentPageTitle').textContent = title;
            
            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                toggleMobileMenu();
            }
            
            // Load section content
            switch(sectionId) {
                case 'adminDashboard':
                    loadAdminDashboard();
                    break;
                case 'adminReports':
                    loadAdminReports();
                    break;
                case 'adminUsers':
                    loadUsersTable();
                    break;
                case 'adminAnalytics':
                    loadAnalytics();
                    break;
                case 'userDashboard':
                    loadUserDashboard();
                    break;
                case 'myReports':
                    loadMyReports();
                    break;
                case 'submitTicket':
                    resetTicketForm();
                    break;
                case 'myTickets':
                    loadMyTickets();
                    break;
                case 'adminTickets':
                    loadAdminTickets();
                    break;
                case 'financialDashboard':
                    loadFinancialDashboard();
                    break;
                case 'salesDashboard':
                    loadSalesDashboard();
                    break;
            }
        }

        // ==================== UNIFIED INTERFACE LOADER ====================
        function loadInterface() {
            const user = AppState.currentUser;
            const role = getRoleInfo(user.role);
            const navMenu = document.getElementById('navMenu');
            let navItems = '';

            if (role.nav.includes('dashboard')) {
                const section = role.canViewAllReports ? 'adminDashboard' : 'userDashboard';
                navItems += `<div class="nav-item active" onclick="navigateTo('${section}', '${t('dashboard')}', this)" role="button" tabindex="0">
                    <i>üìä</i><span>${t('dashboard')}</span></div>`;
            }
            if (role.nav.includes('reports') && role.canViewAllReports) {
                navItems += `<div class="nav-item" onclick="navigateTo('adminReports', '${t('reports')}', this)" role="button" tabindex="0">
                    <i>üìã</i><span>${t('reports')}</span></div>`;
            }
            if (role.nav.includes('users') && role.canManageUsers) {
                navItems += `<div class="nav-item" onclick="navigateTo('adminUsers', '${t('users')}', this)" role="button" tabindex="0">
                    <i>üë•</i><span>${t('users')}</span></div>`;
            }
            if (role.nav.includes('analytics') && role.canViewAnalytics) {
                navItems += `<div class="nav-item" onclick="navigateTo('adminAnalytics', '${t('analytics')}', this)" role="button" tabindex="0">
                    <i>üìà</i><span>${t('analytics')}</span></div>`;
            }
            if (role.canSubmitReport) {
                navItems += `<div class="nav-item" onclick="navigateTo('submitReport', '${t('submitReport')}', this)" role="button" tabindex="0">
                    <i>üìù</i><span>${t('submitReport')}</span></div>`;
            }
            if (role.canViewMyReports) {
                navItems += `<div class="nav-item" onclick="navigateTo('myReports', '${t('myReports')}', this)" role="button" tabindex="0">
                    <i>üìã</i><span>${t('myReports')}</span></div>`;
            }
            if (role.canSubmitTicket) {
                navItems += `<div class="nav-item" onclick="navigateTo('submitTicket', 'Raise Request', this)" role="button" tabindex="0">
                    <i>üé´</i><span>Raise Request</span></div>`;
            }
            if (role.canSubmitTicket) {
                navItems += `<div class="nav-item" onclick="navigateTo('myTickets', 'My Requests', this); loadMyTickets();" role="button" tabindex="0">
                    <i>üì¨</i><span>My Requests</span></div>`;
            }
            if (role.nav.includes('tickets') && Utils.isAdmin()) {
                navItems += `<div class="nav-item" onclick="navigateTo('adminTickets', 'Request Management', this); loadAdminTickets();" role="button" tabindex="0">
                    <i>üì•</i><span>Requests</span><span id="pendingTicketsBadge" style="background:#f44336;color:white;border-radius:10px;padding:1px 7px;font-size:11px;margin-left:6px;display:none;"></span></div>`;
            }
            if (role.nav.includes('financial')) {
                navItems += `<div class="nav-item" onclick="navigateTo('financialDashboard', 'üí∞ Financial', this); loadFinancialDashboard();" role="button" tabindex="0">
                    <i>üí∞</i><span>Financial</span></div>`;
            }
            if (role.canManageCampaigns) {
                navItems += `<div class="nav-item" onclick="navigateTo('salesDashboard', 'üìä Sales', this); loadSalesDashboard();" role="button" tabindex="0">
                    <i>üìä</i><span>Sales & Marketing</span></div>`;
            }

            navMenu.innerHTML = navItems;

            // Show Google Sheets controls only for admin
            const adminControls = document.getElementById('adminOnlyControls');
            if (adminControls) {
                adminControls.style.display = user.role === 'admin' ? 'flex' : 'none';
            }

            // Load the first section
            if (role.canViewAllReports) {
                loadAdminDashboard();
            } else {
                loadUserDashboard();
                if (role.canSubmitReport) {
                    document.getElementById('reportDate').valueAsDate = new Date();
                }
            }
        }

        // ==================== ADMIN DASHBOARD ====================

        function loadAdminDashboard() {
            const reports = AppState.reports;
            
            // Stats
            const totalReports = reports.length;
            const pendingReports = reports.filter(r => r.status === 'pending').length;
            const approvedReports = reports.filter(r => r.status === 'approved').length;
            const activeDrivers = AppState.users.filter(u => u.role === 'driver' && u.status === 'active').length;
            const pendingTickets = AppState.tickets.filter(tk => tk.status === 'pending').length;
            
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${totalReports}</div>
                            <div class="stat-label">Total Reports</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">üìã</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${pendingReports}</div>
                            <div class="stat-label">Pending Review</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">‚è≥</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${pendingTickets}</div>
                            <div class="stat-label">Pending Requests</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ff6b6b, #feca57);">üé´</div>
                    </div>
                    ${Utils.isAdmin() && pendingTickets > 0 ? `<div style="margin-top:10px;"><button class="btn btn-primary" style="font-size:12px;padding:6px 14px;" onclick="navigateTo('adminTickets','Request Management',document.querySelector('.nav-item[onclick*=adminTickets]'));loadAdminTickets()">View Requests ‚Üí</button></div>` : ''}
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${activeDrivers}</div>
                            <div class="stat-label">Active Drivers</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">üë•</div>
                    </div>
                </div>
            `;
            
            // Status Chart
            const statusCounts = {
                pending: pendingReports,
                approved: approvedReports,
                rejected: reports.filter(r => r.status === 'rejected').length
            };
            
            const chartGrid = document.getElementById('adminChartGrid');
            const maxCount = Math.max(...Object.values(statusCounts), 1);
            
            chartGrid.innerHTML = Object.entries(statusCounts).map(([status, count]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${count}</div>
                    <div class="chart-bar" style="height: ${(count / maxCount) * 150}px; background: ${
                        status === 'approved' ? '#4caf50' : 
                        status === 'pending' ? '#ff9800' : '#f44336'
                    }"></div>
                    <div class="chart-label">${status.toUpperCase()}</div>
                </div>
            `).join('');
            
            // Recent reports
            const recentReports = reports.slice(-5).reverse();
            const container = document.getElementById('recentReportsContainer');
            
            if (recentReports.length > 0) {
                container.innerHTML = `
                    <div class="table-header">
                        <h3>Recent Reports</h3>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Driver</th>
                                    <th>Vehicle</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentReports.map(r => `
                                    <tr>
                                        <td data-label="Date">${Utils.formatDate(r.date)}</td>
                                        <td data-label="Driver">${Utils.escapeHTML(r.driverName)}</td>
                                        <td data-label="Vehicle">${Utils.escapeHTML(r.vehicleNumber)}</td>
                                        <td data-label="Type">${Utils.escapeHTML(r.type)}</td>
                                        <td data-label="Status"><span class="badge badge-${Utils.escapeHTML(r.status)}">${Utils.escapeHTML(r.status.toUpperCase())}</span></td>
                                        <td data-label="Actions" class="action-buttons">
                                            <button class="btn-icon" style="background: #e3f2fd; color: #1976d2;" onclick="viewReport(${r.id})">
                                                üëÅÔ∏è
                                            </button>
                                            ${r.status === 'pending' && Utils.isAdmin() ? `
                                                <button class="btn-icon" style="background: #e8f5e9; color: #388e3c;" onclick="approveReport(${r.id})">
                                                    ‚úì
                                                </button>
                                                <button class="btn-icon" style="background: #ffebee; color: #c62828;" onclick="rejectReport(${r.id})">
                                                    ‚úó
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No reports yet</h3>
                        <p>Reports will appear here once drivers submit them</p>
                    </div>
                `;
            }
        }

        function loadAdminReports() {
            const container = document.getElementById('reportsTableContainer');
            const reports = AppState.reports.slice().reverse();
            
            if (reports.length > 0) {
                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Driver</th>
                                <th>Vehicle</th>
                                <th>Type</th>
                                <th>Fuel (L)</th>
                                <th>Expenses</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            ${reports.map(r => `
                                <tr data-search="${Utils.escapeHTML(r.driverName.toLowerCase())} ${Utils.escapeHTML(r.vehicleNumber.toLowerCase())} ${Utils.escapeHTML(r.type.toLowerCase())} ${Utils.escapeHTML(r.status.toLowerCase())}">
                                    <td data-label="ID">#${r.id}</td>
                                    <td data-label="Date">${Utils.formatDate(r.date)}</td>
                                    <td data-label="Driver">${Utils.escapeHTML(r.driverName)}</td>
                                    <td data-label="Vehicle">${Utils.escapeHTML(r.vehicleNumber)}</td>
                                    <td data-label="Type">${Utils.escapeHTML(r.type)}</td>
                                    <td data-label="Fuel">${r.fuel || 0} L</td>
                                    <td data-label="Expenses">${Utils.formatCurrency(r.expenses || 0)}</td>
                                    <td data-label="Status"><span class="badge badge-${Utils.escapeHTML(r.status)}">${Utils.escapeHTML(r.status.toUpperCase())}</span></td>
                                    <td data-label="Actions" class="action-buttons">
                                        <button class="btn-icon" style="background: #e3f2fd; color: #1976d2;" onclick="viewReport(${r.id})" title="View">
                                            üëÅÔ∏è
                                        </button>
                                        ${r.status === 'pending' && Utils.isAdmin() ? `
                                            <button class="btn-icon" style="background: #e8f5e9; color: #388e3c;" onclick="approveReport(${r.id})" title="Approve">
                                                ‚úì
                                            </button>
                                            <button class="btn-icon" style="background: #ffebee; color: #c62828;" onclick="rejectReport(${r.id})" title="Reject">
                                                ‚úó
                                            </button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No reports submitted</h3>
                        <p>Driver reports will appear here</p>
                    </div>
                `;
            }
        }

        function loadAnalytics() {
            const reports = AppState.reports;
            
            // Analytics Stats
            const totalExpenses = reports.reduce((sum, r) => sum + (r.expenses || 0), 0);
            const totalFuel = reports.reduce((sum, r) => sum + (r.fuel || 0), 0);
            const avgExpenses = reports.length > 0 ? totalExpenses / reports.length : 0;
            const reportsThisMonth = reports.filter(r => {
                const reportDate = new Date(r.date);
                const now = new Date();
                return reportDate.getMonth() === now.getMonth() && 
                       reportDate.getFullYear() === now.getFullYear();
            }).length;
            
            document.getElementById('analyticsStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${Utils.formatCurrency(totalExpenses)}</div>
                            <div class="stat-label">Total Expenses</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">üí∞</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${totalFuel.toFixed(1)} L</div>
                            <div class="stat-label">Total Fuel</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">‚õΩ</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${Utils.formatCurrency(avgExpenses)}</div>
                            <div class="stat-label">Avg. per Report</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">üìä</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${reportsThisMonth}</div>
                            <div class="stat-label">Reports This Month</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">üìÖ</div>
                    </div>
                </div>
            `;
            
            // Status Chart
            const statusCounts = {
                pending: reports.filter(r => r.status === 'pending').length,
                approved: reports.filter(r => r.status === 'approved').length,
                rejected: reports.filter(r => r.status === 'rejected').length
            };
            
            const statusChart = document.getElementById('statusChart');
            const maxStatus = Math.max(...Object.values(statusCounts), 1);
            
            statusChart.innerHTML = Object.entries(statusCounts).map(([status, count]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${count}</div>
                    <div class="chart-bar" style="height: ${(count / maxStatus) * 150}px; background: ${
                        status === 'approved' ? '#4caf50' : 
                        status === 'pending' ? '#ff9800' : '#f44336'
                    }"></div>
                    <div class="chart-label">${status.toUpperCase()}</div>
                </div>
            `).join('');
            
            // Type Chart
            const typeCounts = {};
            reports.forEach(r => {
                typeCounts[r.type] = (typeCounts[r.type] || 0) + 1;
            });
            
            const typeChart = document.getElementById('typeChart');
            const maxType = Math.max(...Object.values(typeCounts), 1);
            
            typeChart.innerHTML = Object.entries(typeCounts).map(([type, count]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${count}</div>
                    <div class="chart-bar" style="height: ${(count / maxType) * 150}px; background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                    <div class="chart-label">${type}</div>
                </div>
            `).join('');
            
            // Monthly Chart
            const monthlyData = {};
            reports.forEach(r => {
                const month = new Date(r.date).toLocaleString('default', { month: 'short' });
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            
            const monthlyChart = document.getElementById('monthlyChart');
            const maxMonthly = Math.max(...Object.values(monthlyData), 1);
            
            monthlyChart.innerHTML = Object.entries(monthlyData).map(([month, count]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${count}</div>
                    <div class="chart-bar" style="height: ${(count / maxMonthly) * 150}px; background: linear-gradient(135deg, #ff5722, #ff9800);"></div>
                    <div class="chart-label">${month}</div>
                </div>
            `).join('');
        }

        // ==================== USER DASHBOARD ====================

        function loadUserDashboard() {
            const userReports = AppState.reports.filter(r => r.userId === AppState.currentUser.id);
            const totalReports = userReports.length;
            const pendingReports = userReports.filter(r => r.status === 'pending').length;
            const approvedReports = userReports.filter(r => r.status === 'approved').length;
            const rejectedReports = userReports.filter(r => r.status === 'rejected').length;
            
            const statsGrid = document.getElementById('userStatsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${totalReports}</div>
                            <div class="stat-label">Total Reports</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">üìã</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${pendingReports}</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">‚è≥</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${approvedReports}</div>
                            <div class="stat-label">Approved</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">‚úì</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${rejectedReports}</div>
                            <div class="stat-label">Rejected</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a, #fee140);">‚úó</div>
                    </div>
                </div>
            `;
            
            // User Chart
            const statusCounts = { pending: pendingReports, approved: approvedReports, rejected: rejectedReports };
            const chartGrid = document.getElementById('userChartGrid');
            const maxCount = Math.max(...Object.values(statusCounts), 1);
            
            chartGrid.innerHTML = Object.entries(statusCounts).map(([status, count]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${count}</div>
                    <div class="chart-bar" style="height: ${(count / maxCount) * 150}px; background: ${
                        status === 'approved' ? '#4caf50' : 
                        status === 'pending' ? '#ff9800' : '#f44336'
                    }"></div>
                    <div class="chart-label">${status.toUpperCase()}</div>
                </div>
            `).join('');
        }

        // ==================== REPORT FUNCTIONS ====================
        function validateReportForm() {
            let isValid = true;
            const errors = {};
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(e => e.classList.remove('show'));
            document.querySelectorAll('.error').forEach(e => e.classList.remove('error'));
            
            // Validate date
            if (!document.getElementById('reportDate').value) {
                errors.reportDate = 'Date is required';
                isValid = false;
            }
            
            // Validate vehicle number
            const vehicleNumber = document.getElementById('vehicleNumber').value;
            if (!vehicleNumber) {
                errors.vehicleNumber = 'Vehicle number is required';
                isValid = false;
            } else if (!Utils.validateVehicleNumber(vehicleNumber)) {
                errors.vehicleNumber = 'Vehicle number must be in format ABC-1234';
                isValid = false;
            }
            
            // Validate odometer
            const odometer = parseFloat(document.getElementById('odometer').value);
            if (!odometer || odometer < 0) {
                errors.odometer = 'Valid odometer reading is required';
                isValid = false;
            }
            
            // Validate notes
            if (!document.getElementById('reportNotes').value.trim()) {
                errors.reportNotes = 'Notes are required';
                isValid = false;
            }
            
            // Show errors
            Object.keys(errors).forEach(field => {
                const input = document.getElementById(field);
                const errorEl = document.getElementById(`error-${field}`);
                if (input) input.classList.add('error');
                if (errorEl) {
                    errorEl.textContent = errors[field];
                    errorEl.classList.add('show');
                }
            });
            
            return isValid;
        }

        function submitReport() {
            if (!validateReportForm()) {
                Utils.showToast('Please fix the errors in the form', true);
                return;
            }
            
            const newReport = {
                id: Utils.generateId(AppState.reports),
                userId: AppState.currentUser.id,
                driverName: AppState.currentUser.name,
                date: document.getElementById('reportDate').value,
                type: document.getElementById('reportType').value,
                vehicleNumber: document.getElementById('vehicleNumber').value.trim().toUpperCase(),
                odometer: parseInt(document.getElementById('odometer').value),
                fuel: parseFloat(document.getElementById('fuelAmount').value) || 0,
                expenses: parseFloat(document.getElementById('expenses').value) || 0,
                route: document.getElementById('route').value.trim() || 'N/A',
                notes: document.getElementById('reportNotes').value.trim(),
                status: 'pending',
                submittedAt: new Date().toISOString(),
                reviewedAt: null
            };
            
            AppState.reports = [...AppState.reports, newReport];
            
            document.getElementById('reportForm').reset();
            document.getElementById('reportDate').valueAsDate = new Date();
            
            loadUserDashboard();
            Utils.showToast('Report submitted successfully! ‚úì');
            
            setTimeout(() => {
                const myReportsNav = document.querySelector('.nav-item[onclick*="myReports"]');
                if (myReportsNav) {
                    myReportsNav.click();
                }
            }, 1500);
        }

        function resetReportForm() {
            document.getElementById('reportForm').reset();
            document.getElementById('reportDate').valueAsDate = new Date();
            document.querySelectorAll('.error-message').forEach(e => e.classList.remove('show'));
            document.querySelectorAll('.error').forEach(e => e.classList.remove('error'));
        }

        function loadMyReports() {
            const container = document.getElementById('myReportsTableContainer');
            const myReports = AppState.reports
                .filter(r => r.userId === AppState.currentUser.id)
                .slice()
                .reverse();
            
            if (myReports.length > 0) {
                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Vehicle</th>
                                <th>Type</th>
                                <th>Odometer</th>
                                <th>Fuel (L)</th>
                                <th>Expenses</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="myReportsTableBody">
                            ${myReports.map(r => `
                                <tr data-search="${Utils.escapeHTML(r.vehicleNumber.toLowerCase())} ${Utils.escapeHTML(r.type.toLowerCase())} ${Utils.escapeHTML(r.status.toLowerCase())}">
                                    <td data-label="ID">#${r.id}</td>
                                    <td data-label="Date">${Utils.formatDate(r.date)}</td>
                                    <td data-label="Vehicle">${Utils.escapeHTML(r.vehicleNumber)}</td>
                                    <td data-label="Type">${Utils.escapeHTML(r.type)}</td>
                                    <td data-label="Odometer">${r.odometer} km</td>
                                    <td data-label="Fuel">${r.fuel || 0} L</td>
                                    <td data-label="Expenses">${Utils.formatCurrency(r.expenses || 0)}</td>
                                    <td data-label="Status"><span class="badge badge-${Utils.escapeHTML(r.status)}">${Utils.escapeHTML(r.status.toUpperCase())}</span></td>
                                    <td data-label="Actions">
                                        <button class="btn-icon" style="background: #e3f2fd; color: #1976d2;" onclick="viewReport(${r.id})">
                                            üëÅÔ∏è
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No reports yet</h3>
                        <p>Click "Submit Report" to create your first report</p>
                        <button class="btn btn-primary" onclick="document.querySelector('.nav-item[onclick*=submitReport]').click()" style="margin-top: 20px;">
                            ‚ûï Submit Your First Report
                        </button>
                    </div>
                `;
            }
        }

        function viewReport(reportId) {
            const report = AppState.reports.find(r => r.id === reportId);
            if (!report) return;
            
            const details = document.getElementById('reportDetails');
            details.innerHTML = `
                <div style="line-height: 1.8;">
                    <p><strong>Report ID:</strong> #${report.id}</p>
                    <p><strong>Date:</strong> ${Utils.formatDate(report.date, 'long')}</p>
                    <p><strong>Driver:</strong> ${Utils.escapeHTML(report.driverName)}</p>
                    <p><strong>Vehicle:</strong> ${Utils.escapeHTML(report.vehicleNumber)}</p>
                    <p><strong>Type:</strong> ${Utils.escapeHTML(report.type)}</p>
                    <p><strong>Odometer:</strong> ${report.odometer} km</p>
                    <p><strong>Fuel:</strong> ${report.fuel || 0} liters</p>
                    <p><strong>Expenses:</strong> ${Utils.formatCurrency(report.expenses || 0)}</p>
                    <p><strong>Route:</strong> ${Utils.escapeHTML(report.route || 'N/A')}</p>
                    <p><strong>Status:</strong> <span class="badge badge-${Utils.escapeHTML(report.status)}">${Utils.escapeHTML(report.status.toUpperCase())}</span></p>
                    <hr style="margin: 15px 0;">
                    <p><strong>Notes:</strong></p>
                    <p style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 10px;">${Utils.escapeHTML(report.notes)}</p>
                    <p style="margin-top: 15px; font-size: 12px; color: #999;">Submitted: ${Utils.formatDate(report.submittedAt, 'long')}</p>
                    ${report.reviewedAt ? `<p style="font-size: 12px; color: #999;">Reviewed: ${Utils.formatDate(report.reviewedAt, 'long')}</p>` : ''}
                </div>
            `;
            
            openModal('reportModal');
        }

        function approveReport(reportId) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can approve reports', true);
                return;
            }
            const report = AppState.reports.find(r => r.id === reportId);
            if (report && report.status === 'pending') {
                report.status = 'approved';
                report.reviewedAt = new Date().toISOString();
                report.reviewedBy = AppState.currentUser.name;
                AppState.reports = [...AppState.reports];
                loadAdminDashboard();
                loadAdminReports();
                Utils.showToast('Report approved successfully!');
            }
        }

        function rejectReport(reportId) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can reject reports', true);
                return;
            }
            if (confirm('Are you sure you want to reject this report?')) {
                const report = AppState.reports.find(r => r.id === reportId);
                if (report && report.status === 'pending') {
                    report.status = 'rejected';
                    report.reviewedAt = new Date().toISOString();
                    report.reviewedBy = AppState.currentUser.name;
                    AppState.reports = [...AppState.reports];
                    loadAdminDashboard();
                    loadAdminReports();
                    Utils.showToast('Report rejected');
                }
            }
        }

        function filterReports(searchTerm) {
            const rows = document.querySelectorAll('#reportsTableBody tr');
            const term = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const searchText = row.getAttribute('data-search') || '';
                row.style.display = searchText.includes(term) ? '' : 'none';
            });
        }

        function filterMyReports(searchTerm) {
            const rows = document.querySelectorAll('#myReportsTableBody tr');
            const term = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const searchText = row.getAttribute('data-search') || '';
                row.style.display = searchText.includes(term) ? '' : 'none';
            });
        }

        // ==================== USER MANAGEMENT ====================
        function loadUsersTable() {
            const container = document.getElementById('usersTableContainer');
            const users = AppState.users;
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(u => `
                            <tr>
                                <td data-label="ID">#${u.id}</td>
                                <td data-label="Username">${Utils.escapeHTML(u.username)}</td>
                                <td data-label="Name">${Utils.escapeHTML(u.name)}</td>
                                <td data-label="Email">${Utils.escapeHTML(u.email)}</td>
                                <td data-label="Role"><span class="badge" style="background: ${getRoleInfo(u.role).bg}; color: ${getRoleInfo(u.role).color};">${getRoleInfo(u.role).icon} ${Utils.escapeHTML(getRoleInfo(u.role).label)}</span></td>
                                <td data-label="Status"><span class="badge badge-${u.status === 'active' ? 'approved' : 'rejected'}">${Utils.escapeHTML(u.status.toUpperCase())}</span></td>
                                <td data-label="Actions" class="action-buttons">
                                    <button class="btn-icon" style="background: #e3f2fd; color: #1976d2;" onclick="editUser(${u.id})">
                                        ‚úèÔ∏è
                                    </button>
                                    ${u.id !== AppState.currentUser.id && Utils.isAdmin() ? `
                                        <button class="btn-icon" style="background: #ffebee; color: #c62828;" onclick="deleteUser(${u.id})">
                                            üóëÔ∏è
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showAddUserModal() {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can add users', true);
                return;
            }
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('editUserId').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userFullName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = true;
            document.getElementById('passwordRequired').style.display = 'inline';
            document.getElementById('userRole').value = 'driver';
            document.getElementById('userStatus').value = 'active';
            openModal('userModal');
        }

        function editUser(userId) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can edit users', true);
                return;
            }
            const user = AppState.users.find(u => u.id === userId);
            if (user) {
                document.getElementById('userModalTitle').textContent = 'Edit User';
                document.getElementById('editUserId').value = user.id;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userFullName').value = user.name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userPassword').value = '';
                document.getElementById('userPassword').required = false;
                document.getElementById('passwordRequired').style.display = 'none';
                document.getElementById('userRole').value = user.role;
                document.getElementById('userStatus').value = user.status;
                openModal('userModal');
            }
        }

        async function saveUser(event) {
            event.preventDefault();
            
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can save users', true);
                return;
            }
            
            const userId = document.getElementById('editUserId').value;
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const name = document.getElementById('userFullName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value;
            
            // Check for duplicate username
            const existingUser = AppState.users.find(u => 
                u.username.toLowerCase() === username.toLowerCase() && 
                u.id !== parseInt(userId || 0)
            );
            
            if (existingUser) {
                Utils.showToast('Username already exists!', true);
                return;
            }
            
            if (userId) {
                // Update existing user
                const index = AppState.users.findIndex(u => u.id === parseInt(userId));
                if (index !== -1) {
                    const updatedUser = {
                        ...AppState.users[index],
                        username,
                        name,
                        email,
                        role,
                        status
                    };
                    
                    if (password) {
                        updatedUser.password = await Utils.hashPassword(password);
                    }
                    
                    AppState.users[index] = updatedUser;
                }
            } else {
                // Create new user
                const hashedPassword = await Utils.hashPassword(password);
                const newUser = {
                    id: Utils.generateId(AppState.users),
                    username,
                    password: hashedPassword,
                    name,
                    email,
                    role,
                    status,
                    createdAt: new Date().toISOString()
                };
                AppState.users.push(newUser);
            }
            
            AppState.users = [...AppState.users];
            closeModal('userModal');
            loadUsersTable();
            Utils.showToast('User saved successfully!');
        }

        function deleteUser(userId) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can delete users', true);
                return;
            }
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                AppState.users = AppState.users.filter(u => u.id !== userId);
                AppState.reports = AppState.reports.filter(r => r.userId !== userId);
                loadUsersTable();
                Utils.showToast('User deleted successfully');
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        function exportReports(format = 'csv') {
            const reports = AppState.reports;
            
            if (format === 'csv') {
                const headers = ['ID', 'Date', 'Driver', 'Vehicle', 'Type', 'Odometer', 'Fuel', 'Expenses', 'Route', 'Status', 'Submitted'];
                const csv = [
                    headers.join(','),
                    ...reports.map(r => [
                        r.id,
                        r.date,
                        `"${r.driverName}"`,
                        r.vehicleNumber,
                        r.type,
                        r.odometer,
                        r.fuel || 0,
                        r.expenses || 0,
                        `"${r.route || ''}"`,
                        r.status,
                        r.submittedAt
                    ].join(','))
                ].join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reports_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                Utils.showToast('Reports exported successfully!');
            }
        }

        // ==================== MODAL FUNCTIONS ====================
        function openModal(modalId) {
            // Settings modal is admin-only
            if (modalId === 'settingsModal' && !Utils.isAdmin()) {
                Utils.showToast('Access denied: Admin only', true);
                return;
            }
            document.getElementById(modalId).classList.add('show');
            // Focus first input for accessibility
            const modal = document.getElementById(modalId);
            const firstInput = modal.querySelector('input, select, textarea, button');
            if (firstInput) setTimeout(() => firstInput.focus(), 100);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // ==================== LOGOUT ====================
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                AppState.currentUser = null;
                sessionStorage.removeItem('rihlatiSession');
                const adminControls = document.getElementById('adminOnlyControls');
                if (adminControls) adminControls.style.display = 'none';
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('appContainer').classList.remove('show');
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                Utils.showToast('Logged out successfully');
            }
        }

        // ==================== LANGUAGE / RTL SUPPORT ====================
        const i18n = {
            en: {
                appName: 'üöó Rihlati',
                appSubtitle: 'Fleet Management',
                signIn: 'Sign In',
                username: 'Username',
                password: 'Password',
                fleetTitle: 'Rihlati Fleet',
                fleetSubtitle: 'Fleet Management System',
                enterUsername: 'Enter username',
                enterPassword: 'Enter password',
                dashboard: 'Dashboard',
                reports: 'Reports',
                users: 'Users',
                analytics: 'Analytics',
                submitReport: 'Submit Report',
                myReports: 'My Reports',
                logout: 'Logout',
                administrator: 'Administrator',
                driver: 'Driver',
                welcomeBack: (name) => `Welcome back, ${name}!`,
                langToggle: 'ÿπÿ±ÿ®Ÿä',
                recentReports: 'Recent Reports',
                allReports: 'üìã All Reports',
                userManagement: 'üë• User Management',
                addUser: '‚ûï Add User',
                exportCSV: 'üì• Export CSV',
                searchReports: 'Search reports...',
                searchMyReports: 'Search my reports...',
            },
            ar: {
                appName: 'üöó ÿ±ÿ≠ŸÑÿ™Ÿä',
                appSubtitle: 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿ∑ŸàŸÑ',
                signIn: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ',
                username: 'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
                password: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±',
                fleetTitle: 'ÿ±ÿ≠ŸÑÿ™Ÿä',
                fleetSubtitle: 'ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ£ÿ≥ÿ∑ŸàŸÑ',
                enterUsername: 'ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
                enterPassword: 'ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±',
                dashboard: 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ',
                reports: 'ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±',
                users: 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ',
                analytics: 'ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™',
                submitReport: 'ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇÿ±Ÿäÿ±',
                myReports: 'ÿ™ŸÇÿßÿ±Ÿäÿ±Ÿä',
                logout: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨',
                administrator: 'ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ',
                driver: 'ÿ≥ÿßÿ¶ŸÇ',
                welcomeBack: (name) => `ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ÿπŸàÿØÿ™ŸÉÿå ${name}!`,
                langToggle: 'EN',
                recentReports: 'ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑÿ£ÿÆŸäÿ±ÿ©',
                allReports: 'üìã ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±',
                userManagement: 'üë• ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ',
                addUser: '‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ',
                exportCSV: 'üì• ÿ™ÿµÿØŸäÿ± CSV',
                searchReports: 'ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±...',
                searchMyReports: 'ÿ®ÿ≠ÿ´ ŸÅŸä ÿ™ŸÇÿßÿ±Ÿäÿ±Ÿä...',
            }
        };

        let currentLang = localStorage.getItem('rihlatiLang') || 'en';

        function t(key, ...args) {
            const val = i18n[currentLang][key];
            return typeof val === 'function' ? val(...args) : (val || i18n['en'][key] || key);
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            localStorage.setItem('rihlatiLang', currentLang);
            applyLanguage();
        }

        function applyLanguage() {
            const isRTL = currentLang === 'ar';
            document.body.dir = isRTL ? 'rtl' : 'ltr';
            document.documentElement.lang = currentLang;

            // Lang toggle buttons
            document.querySelectorAll('#langToggle').forEach(btn => btn.textContent = t('langToggle'));

            // Login page
            const loginTitle = document.querySelector('.login-header h1');
            if (loginTitle) loginTitle.textContent = t('fleetTitle');
            const loginSub = document.querySelector('.login-header p');
            if (loginSub) loginSub.textContent = t('fleetSubtitle');
            const userLabel = document.querySelector('.login-form label[for="loginUsername"], .login-form label:first-of-type');
            document.querySelectorAll('.login-form label').forEach((label, i) => {
                if (i === 0) label.textContent = t('username');
                if (i === 1) label.textContent = t('password');
            });
            const userInput = document.getElementById('loginUsername');
            if (userInput) userInput.placeholder = t('enterUsername');
            const passInput = document.getElementById('loginPassword');
            if (passInput) passInput.placeholder = t('enterPassword');
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn && !loginBtn.disabled) loginBtn.innerHTML = `<span>${t('signIn')}</span>`;

            // Sidebar
            const sidebarAppName = document.querySelector('.sidebar-header h2');
            if (sidebarAppName) sidebarAppName.textContent = t('appName');
            const sidebarSubtitle = document.querySelector('.sidebar-header p');
            if (sidebarSubtitle) sidebarSubtitle.textContent = t('appSubtitle');
            const userRoleEl = document.getElementById('sidebarUserRole');
            if (userRoleEl && AppState.currentUser) {
                const rInfo = getRoleInfo(AppState.currentUser.role);
                userRoleEl.textContent = currentLang === 'ar' ? rInfo.labelAr : rInfo.label;
            }

            // Re-render nav menu items if logged in
            if (AppState.currentUser) {
                loadInterface();
            }

            // Logout label
            const logoutLabel = document.getElementById('logoutLabel');
            if (logoutLabel) logoutLabel.textContent = t('logout');
        }

        // Apply language on load
        (function() {
            currentLang = localStorage.getItem('rihlatiLang') || 'en';
            document.body.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = currentLang;
        })();

        // ==================== TICKET SYSTEM ====================
        let currentTicketType = null;

        function selectTicketType(type) {
            currentTicketType = type;
            document.querySelectorAll('.ticket-type-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(`ttype-${type}`).classList.add('selected');
            document.getElementById('ticketStep1Btn').disabled = false;
        }

        function ticketNextStep(step) {
            // Validate step 2 before moving to 3
            if (step === 3 && !validateTicketForm()) return;

            [1,2,3].forEach(n => {
                document.getElementById(`ticketStep${n}`).classList.remove('active');
                const dot = document.getElementById(`sdot${n}`);
                dot.classList.remove('active', 'done');
                if (n < step) { dot.classList.add('done'); }
                if (n === step) { dot.classList.add('active'); }
                if (n < 3) {
                    const line = document.getElementById(`sline${n}`);
                    line.classList.toggle('done', n < step);
                }
            });
            document.getElementById(`ticketStep${step}`).classList.add('active');

            if (step === 2) {
                // Show relevant fields
                ['maintenance','fuel','leave'].forEach(t => {
                    document.getElementById(`ticketFields-${t}`).style.display = t === currentTicketType ? 'block' : 'none';
                });
                document.getElementById('ticketFormTitle').textContent =
                    `Step 2: ${currentTicketType === 'maintenance' ? 'üîß Maintenance' : currentTicketType === 'fuel' ? '‚õΩ Fuel' : 'üèñÔ∏è Leave'} Request Details`;
            }

            if (step === 3) {
                buildTicketPreview();
            }
        }

        function validateTicketForm() {
            const t = currentTicketType;
            if (t === 'maintenance') {
                if (!document.getElementById('t-maint-driver').value.trim()) { Utils.showToast('Driver name is required', true); return false; }
                if (!document.getElementById('t-maint-type').value) { Utils.showToast('Maintenance type is required', true); return false; }
                if (!document.getElementById('t-maint-cost').value) { Utils.showToast('Estimated cost is required', true); return false; }
                if (!document.getElementById('t-maint-notes').value.trim()) { Utils.showToast('Description is required', true); return false; }
            } else if (t === 'fuel') {
                if (!document.getElementById('t-fuel-driver').value.trim()) { Utils.showToast('Driver name is required', true); return false; }
                if (!document.getElementById('t-fuel-liters').value) { Utils.showToast('Fuel amount is required', true); return false; }
                if (!document.getElementById('t-fuel-cost').value) { Utils.showToast('Estimated cost is required', true); return false; }
                if (!document.getElementById('t-fuel-date').value) { Utils.showToast('Required date is required', true); return false; }
                if (!document.getElementById('t-fuel-notes').value.trim()) { Utils.showToast('Reason is required', true); return false; }
            } else if (t === 'leave') {
                if (!document.getElementById('t-leave-driver').value.trim()) { Utils.showToast('Driver name is required', true); return false; }
                if (!document.getElementById('t-leave-type').value) { Utils.showToast('Leave type is required', true); return false; }
                if (!document.getElementById('t-leave-from').value) { Utils.showToast('From date is required', true); return false; }
                if (!document.getElementById('t-leave-to').value) { Utils.showToast('To date is required', true); return false; }
                if (!document.getElementById('t-leave-notes').value.trim()) { Utils.showToast('Reason is required', true); return false; }
            }
            return true;
        }

        function buildTicketPreview() {
            const t = currentTicketType;
            let rows = '';
            if (t === 'maintenance') {
                rows = [
                    ['Type', 'üîß Maintenance Request'],
                    ['Driver', document.getElementById('t-maint-driver').value],
                    ['Vehicle', document.getElementById('t-maint-vehicle').value || 'N/A'],
                    ['Maintenance Type', document.getElementById('t-maint-type').value.replace('_',' ')],
                    ['Estimated Cost', `SAR ${document.getElementById('t-maint-cost').value || '0'}`],
                    ['Priority', document.getElementById('t-maint-priority').value.toUpperCase()],
                    ['Requested Date', document.getElementById('t-maint-date').value || 'ASAP'],
                    ['Description', document.getElementById('t-maint-notes').value],
                ].map(([l,v]) => `<div class="ticket-detail-row"><span class="ticket-detail-label">${l}</span><span class="ticket-detail-value">${Utils.escapeHTML(String(v))}</span></div>`).join('');
            } else if (t === 'fuel') {
                rows = [
                    ['Type', '‚õΩ Fuel Request'],
                    ['Driver', document.getElementById('t-fuel-driver').value],
                    ['Vehicle', document.getElementById('t-fuel-vehicle').value || 'N/A'],
                    ['Fuel Amount', `${document.getElementById('t-fuel-liters').value} Liters`],
                    ['Est. Cost', `SAR ${document.getElementById('t-fuel-cost').value || '0'}`],
                    ['Station', document.getElementById('t-fuel-station').value || 'N/A'],
                    ['Required Date', document.getElementById('t-fuel-date').value],
                    ['Reason', document.getElementById('t-fuel-notes').value],
                ].map(([l,v]) => `<div class="ticket-detail-row"><span class="ticket-detail-label">${l}</span><span class="ticket-detail-value">${Utils.escapeHTML(String(v))}</span></div>`).join('');
            } else {
                const from = document.getElementById('t-leave-from').value;
                const to   = document.getElementById('t-leave-to').value;
                rows = [
                    ['Type', 'üèñÔ∏è Leave Request'],
                    ['Driver', document.getElementById('t-leave-driver').value],
                    ['Leave Type', document.getElementById('t-leave-type').value],
                    ['From', from],
                    ['To', to],
                    ['Days', document.getElementById('t-leave-days').value || calcLeaveDays(from, to)],
                    ['Replacement', document.getElementById('t-leave-replacement').value || 'None'],
                    ['Reason', document.getElementById('t-leave-notes').value],
                ].map(([l,v]) => `<div class="ticket-detail-row"><span class="ticket-detail-label">${l}</span><span class="ticket-detail-value">${Utils.escapeHTML(String(v))}</span></div>`).join('');
            }
            document.getElementById('ticketPreview').innerHTML = rows;
        }

        function calcLeaveDays(from, to) {
            if (!from || !to) return '';
            const diff = (new Date(to) - new Date(from)) / (1000*60*60*24);
            return diff >= 0 ? diff + 1 : '';
        }

        function submitTicket() {
            const t = currentTicketType;
            const user = AppState.currentUser;
            let data = { type: t };

            if (t === 'maintenance') {
                data = { ...data,
                    driverName:   document.getElementById('t-maint-driver').value.trim(),
                    vehicle:      document.getElementById('t-maint-vehicle').value.trim(),
                    maintType:    document.getElementById('t-maint-type').value,
                    cost:         parseFloat(document.getElementById('t-maint-cost').value) || 0,
                    priority:     document.getElementById('t-maint-priority').value,
                    requestedDate: document.getElementById('t-maint-date').value,
                    notes:        document.getElementById('t-maint-notes').value.trim(),
                };
            } else if (t === 'fuel') {
                data = { ...data,
                    driverName:   document.getElementById('t-fuel-driver').value.trim(),
                    vehicle:      document.getElementById('t-fuel-vehicle').value.trim(),
                    liters:       parseFloat(document.getElementById('t-fuel-liters').value),
                    cost:         parseFloat(document.getElementById('t-fuel-cost').value) || 0,
                    station:      document.getElementById('t-fuel-station').value.trim(),
                    requestedDate: document.getElementById('t-fuel-date').value,
                    notes:        document.getElementById('t-fuel-notes').value.trim(),
                };
            } else {
                const from = document.getElementById('t-leave-from').value;
                const to   = document.getElementById('t-leave-to').value;
                data = { ...data,
                    driverName:   document.getElementById('t-leave-driver').value.trim(),
                    leaveType:    document.getElementById('t-leave-type').value,
                    from, to,
                    days:         calcLeaveDays(from, to),
                    replacement:  document.getElementById('t-leave-replacement').value.trim(),
                    notes:        document.getElementById('t-leave-notes').value.trim(),
                };
            }

            const ticket = {
                id:          Utils.generateId(AppState.tickets),
                submittedBy: user.id,
                submitterName: user.name,
                submitterRole: user.role,
                status:      'pending',
                submittedAt: new Date().toISOString(),
                reviewedAt:  null,
                reviewedBy:  null,
                reviewNote:  '',
                ...data
            };

            AppState.tickets = [...AppState.tickets, ticket];
            Utils.showToast('‚úÖ Request submitted! Awaiting Admin approval.');
            resetTicketForm();

            // Update pending badge for admin
            updatePendingTicketsBadge();

            // Navigate to my tickets
            setTimeout(() => {
                const myTicketsNav = document.querySelector('.nav-item[onclick*="myTickets"]');
                if (myTicketsNav) myTicketsNav.click();
            }, 1200);
        }

        function resetTicketForm() {
            currentTicketType = null;
            document.querySelectorAll('.ticket-type-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('ticketStep1Btn').disabled = true;
            // Clear all fields
            ['t-maint-driver','t-maint-vehicle','t-maint-cost','t-maint-date','t-maint-notes',
             't-fuel-driver','t-fuel-vehicle','t-fuel-liters','t-fuel-cost','t-fuel-station','t-fuel-date','t-fuel-notes',
             't-leave-driver','t-leave-from','t-leave-to','t-leave-days','t-leave-replacement','t-leave-notes']
            .forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
            ['t-maint-type','t-maint-priority','t-leave-type'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.selectedIndex = 0;
            });
            ticketNextStep(1);
        }

        // Auto-calculate days for leave
        document.addEventListener('change', function(e) {
            if (e.target.id === 't-leave-from' || e.target.id === 't-leave-to') {
                const from = document.getElementById('t-leave-from').value;
                const to   = document.getElementById('t-leave-to').value;
                const days = calcLeaveDays(from, to);
                document.getElementById('t-leave-days').value = days;
            }
        });

        function loadMyTickets() {
            const container = document.getElementById('myTicketsTableContainer');
            const myTickets = AppState.tickets
                .filter(tk => tk.submittedBy === AppState.currentUser.id)
                .slice().reverse();

            if (myTickets.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon">üì¨</div>
                    <h3>No requests yet</h3>
                    <p>Click "Raise Request" to submit your first request</p></div>`;
                return;
            }

            container.innerHTML = `<table>
                <thead><tr>
                    <th>ID</th><th>Type</th><th>Driver</th><th>Details</th>
                    <th>Priority</th><th>Submitted</th><th>Status</th><th>Actions</th>
                </tr></thead>
                <tbody>
                ${myTickets.map(tk => `
                    <tr class="ticket-row-${tk.type}">
                        <td data-label="ID">#${tk.id}</td>
                        <td data-label="Type">${ticketTypeBadge(tk.type)}</td>
                        <td data-label="Driver">${Utils.escapeHTML(tk.driverName)}</td>
                        <td data-label="Details">${ticketSummary(tk)}</td>
                        <td data-label="Priority">${tk.priority ? `<span class="priority-badge priority-${tk.priority}">${tk.priority}</span>` : '‚Äî'}</td>
                        <td data-label="Submitted">${Utils.formatDate(tk.submittedAt)}</td>
                        <td data-label="Status"><span class="badge badge-${tk.status}">${tk.status.toUpperCase()}</span></td>
                        <td data-label="Actions">
                            <button class="btn-icon" style="background:#e3f2fd;color:#1976d2;" onclick="viewTicket(${tk.id})">üëÅÔ∏è</button>
                        </td>
                    </tr>`).join('')}
                </tbody></table>`;
        }

        function loadAdminTickets() {
            if (!Utils.isAdmin()) {
                document.getElementById('adminTicketsTableContainer').innerHTML = 
                    `<div class="empty-state"><div class="empty-state-icon">üîí</div><h3>Access Denied</h3><p>Only administrators can manage requests</p></div>`;
                return;
            }
            
            const container = document.getElementById('adminTicketsTableContainer');
            const typeFilter   = document.getElementById('ticketTypeFilter')?.value   || '';
            const statusFilter = document.getElementById('ticketStatusFilter')?.value || '';

            let tickets = AppState.tickets.slice().reverse();
            if (typeFilter)   tickets = tickets.filter(tk => tk.type   === typeFilter);
            if (statusFilter) tickets = tickets.filter(tk => tk.status === statusFilter);

            if (tickets.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon">üì•</div>
                    <h3>No requests found</h3>
                    <p>Requests from users will appear here</p></div>`;
                return;
            }

            container.innerHTML = `<table>
                <thead><tr>
                    <th>ID</th><th>Type</th><th>From</th><th>Driver</th><th>Details</th>
                    <th>Priority</th><th>Submitted</th><th>Status</th><th>Actions</th>
                </tr></thead>
                <tbody>
                ${tickets.map(tk => `
                    <tr class="ticket-row-${tk.type}">
                        <td data-label="ID">#${tk.id}</td>
                        <td data-label="Type">${ticketTypeBadge(tk.type)}</td>
                        <td data-label="From">${Utils.escapeHTML(tk.submitterName)}<br><small style="color:#888">${getRoleInfo(tk.submitterRole).label}</small></td>
                        <td data-label="Driver">${Utils.escapeHTML(tk.driverName)}</td>
                        <td data-label="Details">${ticketSummary(tk)}</td>
                        <td data-label="Priority">${tk.priority ? `<span class="priority-badge priority-${tk.priority}">${tk.priority}</span>` : '‚Äî'}</td>
                        <td data-label="Submitted">${Utils.formatDate(tk.submittedAt)}</td>
                        <td data-label="Status"><span class="badge badge-${tk.status}">${tk.status.toUpperCase()}</span></td>
                        <td data-label="Actions" class="action-buttons">
                            <button class="btn-icon" style="background:#e3f2fd;color:#1976d2;" onclick="viewTicket(${tk.id})">üëÅÔ∏è</button>
                            ${tk.status === 'pending' ? `
                            <button class="btn-icon" style="background:#e8f5e9;color:#388e3c;" onclick="approveTicket(${tk.id}, true)" title="Approve">‚úì</button>
                            <button class="btn-icon" style="background:#ffebee;color:#c62828;" onclick="rejectTicket(${tk.id}, true)"  title="Reject">‚úó</button>` : ''}
                        </td>
                    </tr>`).join('')}
                </tbody></table>`;
        }

        function ticketTypeBadge(type) {
            const map = { maintenance:'üîß Maintenance', fuel:'‚õΩ Fuel', leave:'üèñÔ∏è Leave' };
            return `<span class="badge badge-${type}">${map[type] || type}</span>`;
        }

        function ticketSummary(tk) {
            if (tk.type === 'maintenance') return Utils.escapeHTML(`${tk.maintType || ''} ${tk.vehicle ? '‚Äì '+tk.vehicle : ''}`);
            if (tk.type === 'fuel') return Utils.escapeHTML(`${tk.liters}L ${tk.vehicle ? '‚Äì '+tk.vehicle : ''}`);
            if (tk.type === 'leave') return Utils.escapeHTML(`${tk.leaveType} (${tk.from} ‚Üí ${tk.to}, ${tk.days} days)`);
            return '';
        }

        function viewTicket(ticketId) {
            const tk = AppState.tickets.find(t => t.id === ticketId);
            if (!tk) return;

            let fields = [];
            if (tk.type === 'maintenance') {
                fields = [
                    ['Request Type','üîß Maintenance Request'],
                    ['Driver Name', tk.driverName],
                    ['Vehicle', tk.vehicle || 'N/A'],
                    ['Maintenance Type', tk.maintType?.replace(/_/g,' ') || 'N/A'],
                    ['Estimated Cost', `<span class="${tk.status === 'pending' ? 'amount-pending' : tk.status === 'approved' ? 'amount-approved' : 'amount-rejected'}">${Utils.formatCurrency(tk.cost || 0)}</span>`],
                    ['Priority', `<span class="priority-badge priority-${tk.priority}">${tk.priority || 'N/A'}</span>`],
                    ['Requested Date', tk.requestedDate || 'ASAP'],
                    ['Description', tk.notes],
                ];
            } else if (tk.type === 'fuel') {
                fields = [
                    ['Request Type','‚õΩ Fuel Request'],
                    ['Driver Name', tk.driverName],
                    ['Vehicle', tk.vehicle || 'N/A'],
                    ['Fuel Amount', `${tk.liters} Liters`],
                    ['Est. Cost', `<span class="${tk.status === 'pending' ? 'amount-pending' : tk.status === 'approved' ? 'amount-approved' : 'amount-rejected'}">${Utils.formatCurrency(tk.cost || 0)}</span>`],
                    ['Station', tk.station || 'N/A'],
                    ['Required Date', tk.requestedDate],
                    ['Reason', tk.notes],
                ];
            } else {
                fields = [
                    ['Request Type','üèñÔ∏è Leave Request'],
                    ['Driver Name', tk.driverName],
                    ['Leave Type', tk.leaveType],
                    ['From Date', tk.from],
                    ['To Date', tk.to],
                    ['No. of Days', tk.days],
                    ['Replacement', tk.replacement || 'None'],
                    ['Reason', tk.notes],
                ];
            }
            fields.push(
                ['Submitted By', `${Utils.escapeHTML(tk.submitterName)} (${getRoleInfo(tk.submitterRole).label})`],
                ['Submitted At', Utils.formatDate(tk.submittedAt, 'long')],
                ['Status', `<span class="badge badge-${tk.status}">${tk.status.toUpperCase()}</span>`],
            );
            if (tk.reviewedAt) {
                fields.push(['Reviewed At', Utils.formatDate(tk.reviewedAt, 'long')]);
                if (tk.reviewNote) fields.push(['Review Note', tk.reviewNote]);
            }

            document.getElementById('ticketDetailContent').innerHTML =
                fields.map(([l,v]) => `<div class="ticket-detail-row">
                    <span class="ticket-detail-label">${l}</span>
                    <span class="ticket-detail-value">${typeof v === 'string' && !v.startsWith('<') ? Utils.escapeHTML(v) : v}</span>
                </div>`).join('');

            // Show approve/reject only for admin and if ticket is pending
            const actionsDiv = document.getElementById('ticketApprovalActions');
            if (Utils.isAdmin() && tk.status === 'pending') {
                actionsDiv.style.display = 'flex';
                actionsDiv.innerHTML = `
                    <div style="width:100%">
                        <div class="form-group" style="margin-bottom:12px;">
                            <label style="font-size:13px;font-weight:600;color:var(--primary-color);">Review Note (optional)</label>
                            <input type="text" id="ticketReviewNote" class="sheet-url-input" placeholder="Add a note for the requester..." style="font-family:inherit;">
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button class="btn btn-success" style="flex:1;" onclick="approveTicket(${tk.id}, true)">‚úì Approve Request</button>
                            <button class="btn btn-danger"  style="flex:1;" onclick="rejectTicket(${tk.id}, true)">‚úó Reject Request</button>
                        </div>
                    </div>`;
            } else {
                actionsDiv.style.display = 'none';
            }

            openModal('ticketModal');
        }

        function approveTicket(ticketId, fromModal = false) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can approve requests', true);
                return;
            }
            const tk = AppState.tickets.find(t => t.id === ticketId);
            if (!tk || tk.status !== 'pending') return;
            tk.status = 'approved';
            tk.reviewedAt = new Date().toISOString();
            tk.reviewedBy = AppState.currentUser.name;
            tk.reviewNote = fromModal ? (document.getElementById('ticketReviewNote')?.value || '') : '';
            AppState.tickets = [...AppState.tickets];
            Utils.showToast('‚úÖ Request approved!');
            if (fromModal) closeModal('ticketModal');
            loadAdminTickets();
            updatePendingTicketsBadge();
        }

        function rejectTicket(ticketId, fromModal = false) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can reject requests', true);
                return;
            }
            const tk = AppState.tickets.find(t => t.id === ticketId);
            if (!tk || tk.status !== 'pending') return;
            const note = fromModal ? (document.getElementById('ticketReviewNote')?.value || '') : '';
            if (!note && !confirm('Reject this request? Add a review note for better feedback.')) return;
            tk.status = 'rejected';
            tk.reviewedAt = new Date().toISOString();
            tk.reviewedBy = AppState.currentUser.name;
            tk.reviewNote = note;
            AppState.tickets = [...AppState.tickets];
            Utils.showToast('Request rejected');
            if (fromModal) closeModal('ticketModal');
            loadAdminTickets();
            updatePendingTicketsBadge();
        }

        function filterMyTickets(term) {
            const rows = document.querySelectorAll('#myTicketsTableContainer tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(term.toLowerCase()) ? '' : 'none';
            });
        }

        function updatePendingTicketsBadge() {
            const badge = document.getElementById('pendingTicketsBadge');
            if (!badge) return;
            const count = AppState.tickets.filter(tk => tk.status === 'pending').length;
            badge.textContent = count;
            badge.style.display = Utils.isAdmin() && count > 0 ? 'inline' : 'none';
        }

        // ==================== FINANCIAL DASHBOARD (View Only) ====================
        function loadFinancialDashboard() {
            const tickets = AppState.tickets.filter(t => t.status === 'pending' && (t.type === 'maintenance' || t.type === 'fuel'));
            const reports = AppState.reports.filter(r => r.status === 'pending' && r.expenses > 0);
            
            // Summary calculations
            const totalPendingAmount = [
                ...tickets.map(t => t.cost || 0),
                ...reports.map(r => r.expenses || 0)
            ].reduce((sum, val) => sum + val, 0);
            
            const pendingMaintenance = tickets.filter(t => t.type === 'maintenance').reduce((sum, t) => sum + (t.cost || 0), 0);
            const pendingFuel = tickets.filter(t => t.type === 'fuel').reduce((sum, t) => sum + (t.cost || 0), 0);
            const pendingExpenses = reports.reduce((sum, r) => sum + (r.expenses || 0), 0);
            
            document.getElementById('financialSummary').innerHTML = `
                <div class="summary-card">
                    <h4>Pending Financial Items</h4>
                    <div class="amount">${Utils.formatCurrency(totalPendingAmount)}</div>
                    <div class="sub">Total amount awaiting approval</div>
                </div>
                <div class="summary-card">
                    <h4>Maintenance</h4>
                    <div class="amount">${Utils.formatCurrency(pendingMaintenance)}</div>
                    <div class="sub">${tickets.filter(t => t.type === 'maintenance').length} requests</div>
                </div>
                <div class="summary-card">
                    <h4>Fuel</h4>
                    <div class="amount">${Utils.formatCurrency(pendingFuel)}</div>
                    <div class="sub">${tickets.filter(t => t.type === 'fuel').length} requests</div>
                </div>
                <div class="summary-card">
                    <h4>Expense Reports</h4>
                    <div class="amount">${Utils.formatCurrency(pendingExpenses)}</div>
                    <div class="sub">${reports.length} reports</div>
                </div>
            `;
            
            // Financial table (View Only)
            const typeFilter = document.getElementById('financialTypeFilter')?.value || '';
            let financialItems = [];
            
            // Add tickets
            tickets.forEach(t => {
                financialItems.push({
                    id: `T${t.id}`,
                    type: t.type,
                    title: t.type === 'maintenance' ? t.maintType?.replace(/_/g, ' ') : `${t.liters}L Fuel`,
                    driver: t.driverName,
                    amount: t.cost || 0,
                    date: t.submittedAt,
                    status: 'pending',
                    priority: t.priority,
                    original: t,
                    source: 'ticket'
                });
            });
            
            // Add expense reports
            reports.forEach(r => {
                financialItems.push({
                    id: `R${r.id}`,
                    type: 'report',
                    title: `${r.type} Report`,
                    driver: r.driverName,
                    amount: r.expenses || 0,
                    date: r.submittedAt,
                    status: 'pending',
                    vehicle: r.vehicleNumber,
                    original: r,
                    source: 'report'
                });
            });
            
            // Apply filter
            if (typeFilter) {
                financialItems = financialItems.filter(item => item.type === typeFilter);
            }
            
            // Sort by date (newest first)
            financialItems.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('financialTableContainer');
            if (financialItems.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon">üí∞</div>
                    <h3>No pending financial items</h3>
                    <p>All financial requests have been processed</p></div>`;
                return;
            }
            
            container.innerHTML = `<table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Driver</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Priority</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                ${financialItems.map(item => `
                    <tr class="financial-row">
                        <td data-label="ID">${item.id}</td>
                        <td data-label="Type">${item.type === 'maintenance' ? 'üîß Maintenance' : item.type === 'fuel' ? '‚õΩ Fuel' : 'üìã Expense'}</td>
                        <td data-label="Driver">${Utils.escapeHTML(item.driver)}</td>
                        <td data-label="Description">${Utils.escapeHTML(item.title)}</td>
                        <td data-label="Amount" class="amount-pending">${Utils.formatCurrency(item.amount)}</td>
                        <td data-label="Date">${Utils.formatDate(item.date)}</td>
                        <td data-label="Priority">${item.priority ? `<span class="priority-badge priority-${item.priority}">${item.priority}</span>` : '‚Äî'}</td>
                        <td data-label="Actions" class="action-buttons">
                            <button class="btn-icon" style="background:#e3f2fd;color:#1976d2;" onclick="viewFinancialItem('${item.source}', ${item.original.id})">üëÅÔ∏è</button>
                            ${Utils.isAdmin() ? `
                                <button class="btn-icon" style="background:#e8f5e9;color:#388e3c;" onclick="approveFinancialItem('${item.source}', ${item.original.id})">‚úì</button>
                                <button class="btn-icon" style="background:#ffebee;color:#c62828;" onclick="rejectFinancialItem('${item.source}', ${item.original.id})">‚úó</button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('')}
                </tbody>
            </table>`;
            
            // Financial chart
            const monthlyData = {};
            const allFinancial = [...tickets, ...reports];
            allFinancial.forEach(item => {
                const month = new Date(item.submittedAt || item.date).toLocaleString('default', { month: 'short' });
                const amount = item.cost || item.expenses || 0;
                monthlyData[month] = (monthlyData[month] || 0) + amount;
            });
            
            const chartGrid = document.getElementById('financialChartGrid');
            const maxAmount = Math.max(...Object.values(monthlyData), 1);
            
            chartGrid.innerHTML = Object.entries(monthlyData).map(([month, amount]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${Utils.formatCurrency(amount)}</div>
                    <div class="chart-bar" style="height: ${(amount / maxAmount) * 150}px; background: linear-gradient(135deg, #2e7d32, #4caf50);"></div>
                    <div class="chart-label">${month}</div>
                </div>
            `).join('');
        }

        function viewFinancialItem(source, id) {
            if (source === 'ticket') {
                viewTicket(id);
            } else {
                viewReport(id);
            }
        }

        function approveFinancialItem(source, id) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can approve financial items', true);
                return;
            }
            if (source === 'ticket') {
                approveTicket(id);
            } else {
                approveReport(id);
            }
            // Reload financial dashboard after a short delay
            setTimeout(loadFinancialDashboard, 500);
        }

        function rejectFinancialItem(source, id) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can reject financial items', true);
                return;
            }
            if (source === 'ticket') {
                rejectTicket(id);
            } else {
                rejectReport(id);
            }
            setTimeout(loadFinancialDashboard, 500);
        }

        // ==================== SALES & MARKETING DASHBOARD ====================
        function loadSalesDashboard() {
            const campaigns = AppState.campaigns || [];
            
            // Summary calculations
            const totalBudget = campaigns.reduce((sum, c) => sum + (c.budget || 0), 0);
            const pendingCampaigns = campaigns.filter(c => c.status === 'pending').length;
            const approvedCampaigns = campaigns.filter(c => c.status === 'approved').length;
            const avgRoi = campaigns.filter(c => c.expectedRoi).reduce((sum, c) => sum + (c.expectedRoi || 0), 0) / (campaigns.filter(c => c.expectedRoi).length || 1);
            
            document.getElementById('salesSummary').innerHTML = `
                <div class="summary-card">
                    <h4>Total Campaign Budget</h4>
                    <div class="amount">${Utils.formatCurrency(totalBudget)}</div>
                    <div class="sub">Across ${campaigns.length} campaigns</div>
                </div>
                <div class="summary-card">
                    <h4>Pending Campaigns</h4>
                    <div class="amount">${pendingCampaigns}</div>
                    <div class="sub">Awaiting approval</div>
                </div>
                <div class="summary-card">
                    <h4>Approved Campaigns</h4>
                    <div class="amount">${approvedCampaigns}</div>
                    <div class="sub">Ready for execution</div>
                </div>
                <div class="summary-card">
                    <h4>Avg. Expected ROI</h4>
                    <div class="amount">${avgRoi.toFixed(1)}%</div>
                    <div class="sub">Return on investment</div>
                </div>
            `;
            
            // Campaigns table
            const container = document.getElementById('campaignRequestsTable');
            const sortedCampaigns = [...campaigns].reverse();
            
            if (sortedCampaigns.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <h3>No campaigns yet</h3>
                    <p>Click "New Campaign Request" to create your first campaign</p></div>`;
                return;
            }
            
            container.innerHTML = `<table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Campaign Name</th>
                        <th>Type</th>
                        <th>Budget</th>
                        <th>Period</th>
                        <th>Expected ROI</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                ${sortedCampaigns.map(c => `
                    <tr>
                        <td data-label="ID">#${c.id}</td>
                        <td data-label="Name">${Utils.escapeHTML(c.name)}</td>
                        <td data-label="Type">${c.type}</td>
                        <td data-label="Budget">${Utils.formatCurrency(c.budget || 0)}</td>
                        <td data-label="Period">${Utils.formatDate(c.startDate)} - ${Utils.formatDate(c.endDate)}</td>
                        <td data-label="ROI">${c.expectedRoi ? c.expectedRoi + '%' : '‚Äî'}</td>
                        <td data-label="Status"><span class="badge badge-${c.status || 'pending'}">${(c.status || 'pending').toUpperCase()}</span></td>
                        <td data-label="Actions" class="action-buttons">
                            <button class="btn-icon" style="background:#e3f2fd;color:#1976d2;" onclick="viewCampaign(${c.id})">üëÅÔ∏è</button>
                            ${Utils.isAdmin() && c.status === 'pending' ? `
                            <button class="btn-icon" style="background:#e8f5e9;color:#388e3c;" onclick="approveCampaign(${c.id})">‚úì</button>
                            <button class="btn-icon" style="background:#ffebee;color:#c62828;" onclick="rejectCampaign(${c.id})">‚úó</button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('')}
                </tbody>
            </table>`;
            
            // ROI Chart
            const roiData = campaigns.filter(c => c.expectedRoi).reduce((acc, c) => {
                acc[c.type] = (acc[c.type] || 0) + (c.expectedRoi || 0);
                return acc;
            }, {});
            
            const roiGrid = document.getElementById('roiChartGrid');
            const maxRoi = Math.max(...Object.values(roiData), 1);
            
            roiGrid.innerHTML = Object.entries(roiData).map(([type, roi]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${roi.toFixed(1)}%</div>
                    <div class="chart-bar" style="height: ${(roi / maxRoi) * 150}px; background: linear-gradient(135deg, #ad1457, #ec407a);"></div>
                    <div class="chart-label">${type}</div>
                </div>
            `).join('');
        }

        function showCampaignRequestModal() {
            document.getElementById('campaignModalTitle').textContent = 'üéØ New Campaign Request';
            document.getElementById('campaignId').value = '';
            document.getElementById('campaignName').value = '';
            document.getElementById('campaignType').value = '';
            document.getElementById('campaignBudget').value = '';
            document.getElementById('campaignStartDate').value = '';
            document.getElementById('campaignEndDate').value = '';
            document.getElementById('campaignRoi').value = '';
            document.getElementById('campaignTarget').value = '';
            document.getElementById('campaignDescription').value = '';
            openModal('campaignModal');
        }

        function saveCampaignRequest(event) {
            event.preventDefault();
            
            const campaignId = document.getElementById('campaignId').value;
            const name = document.getElementById('campaignName').value.trim();
            const type = document.getElementById('campaignType').value;
            const budget = parseFloat(document.getElementById('campaignBudget').value) || 0;
            const startDate = document.getElementById('campaignStartDate').value;
            const endDate = document.getElementById('campaignEndDate').value;
            const expectedRoi = parseFloat(document.getElementById('campaignRoi').value) || null;
            const targetAudience = document.getElementById('campaignTarget').value.trim();
            const description = document.getElementById('campaignDescription').value.trim();
            
            if (!name || !type || !budget || !startDate || !endDate || !description) {
                Utils.showToast('Please fill in all required fields', true);
                return;
            }
            
            const campaign = {
                id: campaignId ? parseInt(campaignId) : Utils.generateId(AppState.campaigns),
                name,
                type,
                budget,
                startDate,
                endDate,
                expectedRoi,
                targetAudience,
                description,
                status: 'pending',
                submittedBy: AppState.currentUser.id,
                submitterName: AppState.currentUser.name,
                submittedAt: new Date().toISOString()
            };
            
            if (campaignId) {
                // Update existing campaign
                const index = AppState.campaigns.findIndex(c => c.id === parseInt(campaignId));
                if (index !== -1) {
                    AppState.campaigns[index] = { ...AppState.campaigns[index], ...campaign };
                }
            } else {
                // Create new campaign
                AppState.campaigns.push(campaign);
            }
            
            AppState.campaigns = [...AppState.campaigns];
            closeModal('campaignModal');
            loadSalesDashboard();
            Utils.showToast('Campaign request submitted successfully!');
        }

        function viewCampaign(campaignId) {
            const campaign = AppState.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            const details = `
                <div style="line-height: 1.8;">
                    <p><strong>Campaign:</strong> ${Utils.escapeHTML(campaign.name)}</p>
                    <p><strong>Type:</strong> ${campaign.type}</p>
                    <p><strong>Budget:</strong> ${Utils.formatCurrency(campaign.budget)}</p>
                    <p><strong>Period:</strong> ${Utils.formatDate(campaign.startDate)} - ${Utils.formatDate(campaign.endDate)}</p>
                    <p><strong>Expected ROI:</strong> ${campaign.expectedRoi ? campaign.expectedRoi + '%' : 'N/A'}</p>
                    <p><strong>Target Audience:</strong> ${campaign.targetAudience || 'N/A'}</p>
                    <p><strong>Status:</strong> <span class="badge badge-${campaign.status}">${campaign.status.toUpperCase()}</span></p>
                    <p><strong>Submitted by:</strong> ${campaign.submitterName}</p>
                    <p><strong>Submitted at:</strong> ${Utils.formatDate(campaign.submittedAt, 'long')}</p>
                    <hr>
                    <p><strong>Description:</strong></p>
                    <p style="background: #f5f5f5; padding: 15px; border-radius: 8px;">${Utils.escapeHTML(campaign.description)}</p>
                </div>
            `;
            
            document.getElementById('financialDetailContent').innerHTML = details;
            document.getElementById('financialModalTitle').textContent = 'üìä Campaign Details';
            openModal('financialModal');
        }

        function approveCampaign(campaignId) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can approve campaigns', true);
                return;
            }
            const campaign = AppState.campaigns.find(c => c.id === campaignId);
            if (campaign && campaign.status === 'pending') {
                campaign.status = 'approved';
                campaign.reviewedAt = new Date().toISOString();
                campaign.reviewedBy = AppState.currentUser.name;
                AppState.campaigns = [...AppState.campaigns];
                loadSalesDashboard();
                Utils.showToast('Campaign approved!');
            }
        }

        function rejectCampaign(campaignId) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can reject campaigns', true);
                return;
            }
            const campaign = AppState.campaigns.find(c => c.id === campaignId);
            if (campaign && campaign.status === 'pending') {
                campaign.status = 'rejected';
                campaign.reviewedAt = new Date().toISOString();
                campaign.reviewedBy = AppState.currentUser.name;
                AppState.campaigns = [...AppState.campaigns];
                loadSalesDashboard();
                Utils.showToast('Campaign rejected');
            }
        }

        // ==================== GOOGLE SHEETS SYNC FUNCTIONS ====================
        let autoSyncInterval = null;

        function setSyncStatus(state, text) {
            const el = document.getElementById('syncStatus');
            const tx = document.getElementById('syncStatusText');
            if (!el || !tx) return;
            el.className = `sync-status ${state}`;
            tx.textContent = text;
        }

        function updateLastSyncLabel() {
            const ts = DataService.getLastSync();
            const el = document.getElementById('lastSyncTime');
            if (!el) return;
            el.textContent = ts ? `Last synced: ${Utils.formatDate(ts, 'long')}` : '';
        }

        function validateSheetsUrl(input) {
            const val = input.value.trim();
            const fb  = document.getElementById('sheetsUrlFeedback');
            if (!val) {
                input.className = 'sheet-url-input';
                fb.textContent  = '';
                return false;
            }
            const valid = val.startsWith('https://script.google.com/macros/s/') && val.endsWith('/exec');
            input.className = `sheet-url-input ${valid ? 'valid' : 'invalid'}`;
            fb.textContent  = valid ? '‚úÖ URL looks correct' : '‚ùå Should start with https://script.google.com/macros/s/ and end with /exec';
            fb.style.color  = valid ? '#2e7d32' : '#c62828';
            return valid;
        }

        function saveSheetsUrl() {
            const input = document.getElementById('sheetsUrlInput');
            const url   = input.value.trim();
            if (!url) { Utils.showToast('Please enter a URL', true); return; }
            if (!validateSheetsUrl(input)) { Utils.showToast('Invalid URL format', true); return; }
            DataService.setSheetsUrl(url);
            document.getElementById('syncActions').style.display = 'flex';
            setSyncStatus('syncing', 'Connecting‚Ä¶');
            Utils.showToast('URL saved! Testing connection‚Ä¶');
            testSheetsConnection();
        }

        async function testSheetsConnection() {
            const url = DataService.getSheetsUrl();
            if (!url) { Utils.showToast('No URL configured', true); return; }
            setSyncStatus('syncing', 'Testing‚Ä¶');
            try {
                const ok = await DataService.ping();
                if (ok) {
                    setSyncStatus('connected', 'Connected');
                    Utils.showToast('‚úÖ Connection successful!');
                } else {
                    setSyncStatus('offline', 'Error');
                    Utils.showToast('Connection failed ‚Äî check your URL', true);
                }
            } catch (e) {
                setSyncStatus('offline', 'Unreachable');
                Utils.showToast(`Connection failed: ${e.message}`, true);
            }
        }

        function disconnectSheets() {
            if (!confirm('Disconnect Google Sheets? Your local data will not be deleted.')) return;
            DataService.clearSheetsUrl();
            document.getElementById('sheetsUrlInput').value = '';
            document.getElementById('sheetsUrlInput').className = 'sheet-url-input';
            document.getElementById('sheetsUrlFeedback').textContent = '';
            document.getElementById('syncActions').style.display = 'none';
            document.getElementById('lastSyncTime').textContent = '';
            setSyncStatus('not-linked', 'Not linked');
            if (autoSyncInterval) { clearInterval(autoSyncInterval); autoSyncInterval = null; }
            document.getElementById('autoSyncToggle').checked = false;
            updateAutoSyncSlider(false);
            Utils.showToast('Google Sheets disconnected');
        }

        async function syncFromSheets() {
            if (!Utils.isAdmin()) return;
            if (!DataService.isLinked()) { Utils.showToast('No Google Sheets URL configured', true); return; }
            setSyncStatus('syncing', 'Pulling‚Ä¶');
            try {
                const counts = await DataService.pullFromSheets();
                // Reload AppState from updated localStorage
                AppState.data = DataService.getData();
                setSyncStatus('connected', 'Synced');
                updateLastSyncLabel();
                Utils.showToast(`‚úÖ Pulled ${counts.users} users & ${counts.reports} reports from Sheets`);
                // Refresh current view
                if (AppState.currentUser) loadInterface();
            } catch (e) {
                setSyncStatus('offline', 'Sync failed');
                Utils.showToast(`Pull failed: ${e.message}`, true);
            }
        }

        async function syncToSheets() {
            if (!Utils.isAdmin()) return;
            if (!DataService.isLinked()) { Utils.showToast('No Google Sheets URL configured', true); return; }
            setSyncStatus('syncing', 'Pushing‚Ä¶');
            try {
                const result = await DataService.pushToSheets();
                setSyncStatus('connected', 'Synced');
                updateLastSyncLabel();
                Utils.showToast(`‚úÖ Pushed ${result.saved?.users ?? '?'} users & ${result.saved?.reports ?? '?'} reports to Sheets`);
            } catch (e) {
                setSyncStatus('offline', 'Sync failed');
                Utils.showToast(`Push failed: ${e.message}`, true);
            }
        }

        function toggleAutoSync(enabled) {
            updateAutoSyncSlider(enabled);
            localStorage.setItem('rihlatiAutoSync', enabled ? '1' : '0');
            if (enabled) {
                if (!DataService.isLinked()) {
                    Utils.showToast('Please connect Google Sheets first', true);
                    document.getElementById('autoSyncToggle').checked = false;
                    updateAutoSyncSlider(false);
                    return;
                }
                autoSyncInterval = setInterval(syncToSheets, 5 * 60 * 1000);
                Utils.showToast('Auto-sync enabled (every 5 min)');
            } else {
                if (autoSyncInterval) { clearInterval(autoSyncInterval); autoSyncInterval = null; }
            }
        }

        function updateAutoSyncSlider(on) {
            const slider = document.getElementById('autoSyncSlider');
            const thumb  = document.getElementById('autoSyncThumb');
            if (!slider) return;
            slider.style.background = on ? '#1a237e' : '#ccc';
            thumb.style.transform   = on ? 'translateX(22px)' : 'translateX(0)';
        }

        function initSheetsUI() {
            const url = DataService.getSheetsUrl();
            if (url) {
                document.getElementById('sheetsUrlInput').value = url;
                validateSheetsUrl(document.getElementById('sheetsUrlInput'));
                document.getElementById('syncActions').style.display = 'flex';
                setSyncStatus('syncing', 'Checking‚Ä¶');
                testSheetsConnection();
            } else {
                setSyncStatus('not-linked', 'Not linked');
            }
            updateLastSyncLabel();
            const autoOn = localStorage.getItem('rihlatiAutoSync') === '1';
            document.getElementById('autoSyncToggle').checked = autoOn;
            updateAutoSyncSlider(autoOn);
            if (autoOn && url) {
                autoSyncInterval = setInterval(syncToSheets, 5 * 60 * 1000);
            }
        }

        // ==================== KEYBOARD NAVIGATION ====================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });

        // Focus trap in modals
        document.querySelectorAll('.modal').forEach(modal => {
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            
            if (focusableElements.length > 0) {
                const firstFocusable = focusableElements[0];
                const lastFocusable = focusableElements[focusableElements.length - 1];
                
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        if (e.shiftKey && document.activeElement === firstFocusable) {
                            e.preventDefault();
                            lastFocusable.focus();
                        } else if (!e.shiftKey && document.activeElement === lastFocusable) {
                            e.preventDefault();
                            firstFocusable.focus();
                        }
                    }
                });
            }
        });

        // ==================== CLOSE MODALS ON OUTSIDE CLICK ====================
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        });

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Apply saved language
            applyLanguage();

            // Initialize Google Sheets UI
            initSheetsUI();

            // Restore session from sessionStorage if available
            const savedSession = sessionStorage.getItem('rihlatiSession');
            if (savedSession) {
                try {
                    const { userId } = JSON.parse(savedSession);
                    const user = AppState.users.find(u => u.id === userId && u.status === 'active');
                    if (user) {
                        AppState.currentUser = user;
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('appContainer').classList.add('show');
                        document.getElementById('userName').textContent = user.name;
                        document.getElementById('sidebarUserRole').textContent = getRoleInfo(user.role).label;
                        document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
                        loadInterface();
                    } else {
                        sessionStorage.removeItem('rihlatiSession');
                    }
                } catch(e) {
                    sessionStorage.removeItem('rihlatiSession');
                }
            }
        });
    </script>
</body>
</html>